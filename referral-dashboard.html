<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Referral Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
  <style>
    /* Your existing CSS here, no changes needed */
    .notification {
      padding: 10px;
      margin-bottom: 20px;
      display: none;
      border-radius: 5px;
    }
    .notification.success {
      background-color: #daf5d7;
      color: #2d662d;
    }
    .notification.error {
      background-color: #fddede;
      color: #a12a2a;
    }
    /* Add any other styles you had originally */
  </style>
</head>
<body>

<!-- Paste your full existing HTML here (the whole referral dashboard UI you provided) -->

<div id="notification" class="notification"></div>

<!-- Assuming your full original dashboard HTML here, I'll just use your exact code for clarity -->

<!-- ... your full existing dashboard markup ... -->

<div class="card-header">
  <div class="card-title">Payout Information</div>
</div>
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
  <div>
    <div class="form-group">
      <label class="form-label">Total Available for Payout</label>
      <input type="text" class="form-input" id="availablePayout" value="KSh 400" readonly>
    </div>
    <div class="form-group">
      <label class="form-label">Next Payout Date</label>
      <input type="text" class="form-input" id="nextPayoutDate" value="15th of each month" readonly>
    </div>
  </div>
  <div>
    <div class="form-group">
      <label class="form-label">Preferred Payment Method</label>
      <select class="form-input" id="paymentMethod">
        <option value="mpesa">M-Pesa</option>
        <option value="bank">Bank Transfer</option>
        <option value="paypal">PayPal</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Minimum Payout Amount</label>
      <input type="text" class="form-input" value="KSh 500" readonly>
    </div>
  </div>
</div>
<button class="btn btn-purple" onclick="updatePaymentMethod()" style="margin-top:15px;">Update Payment Method</button>
</div>
</div>

<!-- Profile Tab -->
<div id="profile" style="display:none;">
  <div class="profile-section">
    <div class="profile-card">
      <div class="profile-header">
        <div class="avatar" id="userAvatar">JD</div>
        <div>
          <div style="font-size:1.4rem;font-weight:700;color:var(--charcoal);" id="profileName">John Doe</div>
          <div style="color:var(--muted);font-size:0.9rem;" id="profileEmail">john@example.com</div>
          <div style="margin-top:8px;">
            <span class="status-completed referral-status">Premium Member</span>
          </div>
        </div>
      </div>
      
      <div class="profile-details">
        <div class="form-group">
          <label class="form-label">Full Name</label>
          <input type="text" class="form-input" id="profileFullName" value="John Doe" readonly>
        </div>
        
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <input type="email" class="form-input" id="profileEmailInput" value="john@example.com" readonly>
        </div>
        
        <div class="form-group">
          <label class="form-label">Phone Number</label>
          <input type="tel" class="form-input" id="profilePhone" value="+254712345678" readonly>
        </div>
        
        <div class="form-group">
          <label class="form-label">Membership Plan</label>
          <input type="text" class="form-input" value="Premium Trading" readonly>
        </div>
        
        <div class="form-group">
          <label class="form-label">Join Date</label>
          <input type="text" class="form-input" value="October 15, 2023" readonly>
        </div>
        
        <div class="form-group">
          <label class="form-label">Referral Code</label>
          <div style="display:flex;gap:10px;">
            <input type="text" class="form-input" id="profileReferralCode" value="JOHNDOE25" readonly style="flex:1;">
            <button class="btn btn-info" onclick="regenerateReferralCode()">Regenerate</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="profile-card">
      <div class="qr-container">
        <div class="qr-code">
          <!-- QR Code would be generated here -->
          <div style="text-align:center;">
            <div style="font-size:3rem;">ðŸ“±</div>
            <div style="font-size:0.8rem;color:var(--muted);margin-top:10px;">Scan to join</div>
          </div>
        </div>
        <div style="color:var(--muted);font-size:0.9rem;margin-bottom:15px;">
          Scan this QR code to quickly access your referral link
        </div>
        <button class="btn" onclick="downloadQRCode()">Download QR Code</button>
      </div>
      
      <div style="margin-top:30px;">
        <div class="card-title" style="margin-bottom:15px;">Account Security</div>
        <button class="btn" style="width:100%;margin-bottom:10px;" onclick="changePassword()">Change Password</button>
        <button class="btn btn-warning" style="width:100%;margin-bottom:10px;" onclick="enable2FA()">Enable Two-Factor Auth</button>
        <button class="btn btn-danger" style="width:100%;" onclick="deactivateAccount()">Deactivate Account</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Initialize Supabase with your keys
  const SUPABASE_URL = 'https://omrsywvfdhzeokmfdrfh.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tcnN5d3ZmZGh6ZW9rbWZkcmZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjAxOTUsImV4cCI6MjA3OTkzNjE5NX0.MaIrC_r3kfgtsNEeGmRCRV7q2_k14sIR7z87OLVSN0o';
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let currentUser = null;

  // Demo email - replace with real logged-in user or auth system later
  const demoEmail = 'john@example.com';

  async function loadUser() {
    try {
      const { data, error } = await supabase
        .from('clients')
        .select('*')
        .eq('email', demoEmail)
        .single();
      if (error) throw error;
      currentUser = data;
      updateUserUI();
      await loadReferrals();
      await loadEarnings();
      updateDashboardStats();
      showNotification('Welcome to your referral dashboard!');
    } catch (error) {
      console.error('Error loading user:', error);
      showNotification('Failed to load user data', 'error');
    }
  }

  function updateUserUI() {
    if (!currentUser) return;
    document.getElementById('userName').textContent = currentUser.name;
    document.getElementById('userEmail').textContent = currentUser.email;
    document.getElementById('profileName').textContent = currentUser.name;
    document.getElementById('profileEmail').textContent = currentUser.email;
    document.getElementById('profileEmailInput').value = currentUser.email;
    document.getElementById('profileFullName').value = currentUser.name;
    document.getElementById('profilePhone').value = currentUser.phone || '+254712345678';
    document.getElementById('profileReferralCode').value = currentUser.referral_code;

    // Set referral code display
    document.getElementById('referralCode').textContent = currentUser.referral_code;

    // Set referral link
    const referralLink = `${window.location.origin}/signup?ref=${currentUser.referral_code}`;
    document.getElementById('referralLink').value = referralLink;

    // Avatar initials
    const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase();
    document.getElementById('userAvatar').textContent = initials;
  }

  // Load referrals data
  async function loadReferrals() {
    try {
      const { data, error } = await supabase
        .from('clients')
        .select('*')
        .eq('referred_by', currentUser.referral_code);
      if (error) throw error;
      window.referrals = data || [];
      renderReferrals();
    } catch (error) {
      console.error('Error loading referrals:', error);
      showNotification('Failed to load referrals', 'error');
    }
  }

  // Render referrals table
  function renderReferrals() {
    const tbody = document.getElementById('referralsTable');
    if (!window.referrals || window.referrals.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No referrals yet</td></tr>';
      return;
    }
    tbody.innerHTML = window.referrals.map(r => `
      <tr>
        <td>${r.name}</td>
        <td>${r.email}</td>
        <td>${new Date(r.created_at).toLocaleDateString()}</td>
        <td><span class="referral-status status-${r.status || 'unknown'}">${capitalize(r.status)}</span></td>
        <td><span class="referral-status status-${r.payment_status === 'paid' ? 'paid' : 'pending'}">${r.payment_status ? capitalize(r.payment_status) : 'Pending'}</span></td>
        <td>KSh ${r.earned || 0}</td>
      </tr>
    `).join('');
  }

  // Load earnings data for referrals
  async function loadEarnings() {
    try {
      if (!window.referrals || window.referrals.length === 0) {
        renderEarnings([]);
        return;
      }
      const referralIds = window.referrals.map(r => r.id);
      const { data, error } = await supabase
        .from('earnings')
        .select('*')
        .in('client_id', referralIds);
      if (error) throw error;
      renderEarnings(data || []);
    } catch (error) {
      console.error('Error loading earnings:', error);
      showNotification('Failed to load earnings', 'error');
    }
  }

  // Render earnings table
  function renderEarnings(earnings) {
    const tbody = document.getElementById('earningsTable');
    if (!earnings || earnings.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No earnings yet</td></tr>';
      return;
    }
    tbody.innerHTML = earnings.map(e => `
      <tr>
        <td>${new Date(e.date).toLocaleDateString()}</td>
        <td>${e.description || 'Referral Commission'}</td>
        <td>${getReferralName(e.client_id)}</td>
        <td>KSh ${parseFloat(e.amount).toLocaleString()}</td>
        <td><span class="referral-status status-${e.status === 'paid' ? 'paid' : 'pending'}">${capitalize(e.status)}</span></td>
        <td>${e.payout_date ? new Date(e.payout_date).toLocaleDateString() : 'â€”'}</td>
      </tr>
    `).join('');
  }

  function getReferralName(client_id) {
    const ref = window.referrals.find(r => r.id === client_id);
    return ref ? ref.name : 'Unknown';
  }

  function updateDashboardStats() {
    const totalReferrals = window.referrals ? window.referrals.length : 0;
    document.getElementById('totalReferrals').textContent = totalReferrals;

    // Calculate earnings and pending payout from earnings table
    const earningsRows = document.querySelectorAll('#earningsTable tr');
    let totalEarnings = 0;
    let pendingPayout = 0;
    let monthlyEarnings = 0;

    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();

    earningsRows.forEach(row => {
      const cells = row.querySelectorAll('td');
      if (cells.length === 6) {
        const amountText = cells[3].textContent.replace(/KSh\s*/g, '').replace(/,/g, '');
        const amount = parseFloat(amountText) || 0;
        const status = cells[4].textContent.trim().toLowerCase();
        const dateText = cells[0].textContent;
        const date = new Date(dateText);

        if (status === 'paid') totalEarnings += amount;
        if (status === 'pending') pendingPayout += amount;
        if (status === 'paid' && date.getMonth() === currentMonth && date.getFullYear() === currentYear) {
          monthlyEarnings += amount;
        }
      }
    });

    document.getElementById('totalEarnings').textContent = `KSh ${totalEarnings.toLocaleString()}`;
    document.getElementById('pendingPayout').textContent = `KSh ${pendingPayout.toLocaleString()}`;
    document.getElementById('monthlyEarnings').textContent = `KSh ${monthlyEarnings.toLocaleString()}`;
    document.getElementById('availablePayout').value = `KSh ${pendingPayout.toLocaleString()}`;
  }

  // Request payout
  async function requestPayout() {
    const pendingText = document.getElementById('availablePayout').value || 'KSh 0';
    const pendingAmount = parseFloat(pendingText.replace(/KSh\s*/g, '').replace(/,/g, '')) || 0;

    if (pendingAmount < 500) {
      showNotification(`Minimum payout amount is KSh 500. You have ${pendingText}`, 'error');
      return;
    }

    if (!confirm(`Request payout of ${pendingText}?`)) return;

    try {
      const { error } = await supabase
        .from('widthrawals')
        .insert([{ client_id: currentUser.id, amount: pendingAmount, status: 'pending', requested_at: new Date().toISOString() }]);
      if (error) throw error;

      showNotification('Payout request submitted! You will receive your payment within 3-5 business days.', 'success');
      await loadEarnings();
      updateDashboardStats();
    } catch (error) {
      console.error('Error requesting payout:', error);
      showNotification('Error submitting payout request.', 'error');
    }
  }

  // Update payment method
  async function updatePaymentMethod() {
    const method = document.getElementById('paymentMethod').value;

    try {
      const { error } = await supabase
        .from('clients')
        .update({ payment_method: method })
        .eq('id', currentUser.id);
      if (error) throw error;

      showNotification(`Payment method updated to ${method.toUpperCase()}`, 'success');
    } catch (error) {
      console.error('Error updating payment method:', error);
      showNotification('Failed to update payment method', 'error');
    }
  }

  // Regenerate referral code
  async function regenerateReferralCode() {
    if (!confirm('Are you sure you want to generate a new referral code? Your old links will stop working.')) return;

    const newCode = 'REF' + Math.floor(Math.random() * 1000000);

    try {
      const { error } = await supabase
        .from('clients')
        .update({ referral_code: newCode })
        .eq('id', currentUser.id);
      if (error) throw error;

      currentUser.referral_code = newCode;
      document.getElementById('referralCode').textContent = newCode;
      document.getElementById('profileReferralCode').value = newCode;
      document.getElementById('referralLink').value = `${window.location.origin}/signup?ref=${newCode}`;
      showNotification('New referral code generated!');
    } catch (error) {
      console.error('Error regenerating referral code:', error);
      showNotification('Failed to regenerate referral code', 'error');
    }
  }

  // Utility function to capitalize strings
  function capitalize(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  // Other functions from your original script (copyReferralLink, shareOnWhatsApp, etc.) remain unchanged
  // Just add your existing code here or keep them as-is

  // Notification helper
  function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.style.display = 'block';
    setTimeout(() => {
      notification.style.display = 'none';
    }, 4000);
  }

  // Load the dashboard on page load
  window.onload = loadUser;

</script>
</body>
</html>
