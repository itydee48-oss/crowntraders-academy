<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Confirm Payment - Crown Trade Academy</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root{--gold:#c8a97e;--gold-dark:#b89463;--nude:#f9f6f2;--charcoal:#3a3a3a}
    body{margin:0;background:linear-gradient(135deg,#f9f6f2,#e8dfd6);font-family:Montserrat;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem}
    .card{background:white;padding:3rem;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.12);max-width:520px;width:100%;text-align:center;border:2px solid rgba(200,169,126,.2)}
    h1{font-family:'Cormorant Garamond';font-size:2.3rem;color:var(--gold-dark);margin-bottom:1rem}
    .copyBox{background:#f3f0eb;padding:1rem;border-radius:12px;margin-top:1rem;display:flex;justify-content:space-between;align-items:center;border:1px solid #ddd}
    .copyText{font-weight:600;font-size:1rem;color:#3a3a3a}
    .copyBtn{background:var(--gold);color:white;padding:.5rem 1rem;border:none;border-radius:8px;font-weight:600;cursor:pointer}
    input{width:100%;padding:1.05rem;margin:1.2rem 0;border:1px solid #ddd;border-radius:12px;font-size:1rem}
    .btn{background:var(--gold);color:white;padding:1.05rem;border:none;border-radius:50px;width:100%;font-weight:700;cursor:pointer;margin-top:1rem}
    .btn:disabled{background:#aaa;cursor:not-allowed}
  </style>
</head>

<body>
<div class="card">
  <h1>Complete Your Payment</h1>
  <p style="color:#555;margin-bottom:2rem">Send <strong>KSh 3,500</strong> via M-Pesa then enter your transaction code.</p>

  <!-- Paybill -->
  <div class="copyBox">
    <span class="copyText">Paybill: <strong>522522</strong></span>
    <button class="copyBtn" onclick="copyText('522522')">Copy</button>
  </div>

  <!-- Account -->
  <div class="copyBox">
    <span class="copyText">Acc: <strong>5173352003212540</strong></span>
    <button class="copyBtn" onclick="copyText('5173352003212540')">Copy</button>
  </div>

  <!-- MPESA Code -->
  <input id="txnCode" type="text" placeholder="Enter MPESA Code (e.g. QJ23H7K91)" />

  <button id="confirmBtn" class="btn">Confirm Payment</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<script>
function copyText(text){
  navigator.clipboard.writeText(text);
  alert("Copied: " + text);
}

(async function(){
  const SUPABASE_URL = "https://omrsywvfdhzeokmfdrfh.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR_ANON_KEY_HERE";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const btn = document.getElementById("confirmBtn");
  const txnEl = document.getElementById("txnCode");

  btn.addEventListener("click", confirmPayment);

  function busy(state){
    btn.disabled = state;
    btn.textContent = state ? "Processing..." : "Confirm Payment";
  }

  async function getUser(){
    const { data } = await supabase.auth.getUser();
    return data?.user || null;
  }

  async function confirmPayment(){
    const txn = txnEl.value.trim();
    if(!txn) return alert("Enter your MPESA code");

    busy(true);

    const user = await getUser();
    if(!user) return alert("Login first.");

    const { data, error } = await supabase
      .from("registrations")
      .update({
        payment_status: "paid",
        transaction_code: txn,
        paid_at: new Date().toISOString()
      })
      .eq("auth_id", user.id)
      .select()
      .single();

    if(error){
      console.error(error);
      alert("Error: " + error.message);
      busy(false);
      return;
    }

    alert("Payment confirmed!");
    window.location.href = "mentorship-dashboard.html";
  }
})();
</script>

</body>
</html>
