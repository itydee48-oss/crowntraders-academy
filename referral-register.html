<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Join Referral Program - Crown Trade Academy</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <style>
    :root { --green:#10b981; }
    body {margin:0;background:linear-gradient(135deg,#f0fdf4,#ecfdf5);font-family:Montserrat;display:flex;align-items:center;justify-content:center;min-height:100vh;padding:2rem;}
    .card {background:white;padding:3.5rem;border-radius:24px;box-shadow:0 30px 80px rgba(0,0,0,.12);max-width:460px;width:100%;text-align:center;border:2px solid rgba(16,185,129,.2);}
    .badge {background:var(--green);color:white;padding:.6rem 1.8rem;border-radius:50px;font-weight:700;font-size:.95rem;display:inline-block;margin-bottom:1rem;text-transform:uppercase;}
    h1 {font-family:'Cormorant Garamond';font-size:2.8rem;color:#065f46;margin:1rem 0;}
    .price {font-size:3.2rem;font-weight:800;color:#065f46;}
    input {width:100%;padding:1.1rem;margin:.9rem 0;border:1px solid #ddd;border-radius:16px;font-size:1rem;}
    .btn {background:var(--green);color:white;padding:1.2rem;border:none;border-radius:50px;width:100%;font-weight:700;font-size:1.2rem;cursor:pointer;margin-top:1.5rem;}
    .highlight {background:#ecfdf5;padding:1rem;border-radius:12px;margin:1.5rem 0;color:#065f46;font-weight:600;}
  </style>
</head>
<body>

<div class="card">
  <div class="badge">High Earnings</div>
  <i class="fas fa-users" style="font-size:4.5rem;color:var(--green);"></i>
  <h1>Referral Partner</h1>
  <div class="price">KSh 2,997 <small style="font-size:1rem;color:#777;">one-time</small></div>
  <div class="highlight">Earn KSh 1,500 per referral â€¢ Paid every Friday</div>

  <input type="text" id="fullName" placeholder="Full Name" required>
  <input type="email" id="email" placeholder="Email Address" required>
  <input type="tel" id="phone" placeholder="Phone (07xxxxxxxx)" required>
  <input type="password" id="password" placeholder="Password (6+ chars)" required>

  <button class="btn" onclick="registerReferral()">Join & Start Earning</button>
</div>

<script>
  const SUPABASE_URL = 'https://omrsywvfdhzeokmfdrfh.supabase.co';
  const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tcnN5d3ZmZGh6ZW9rbWZkcmZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjAxOTUsImV4cCI6MjA3OTkzNjE5NX0.MaIrC_r3kfgtsNEeGmRCRV7q2_k14sIR7z87OLVSN0o';

  // Extract referral code from URL
  const params = new URLSearchParams(window.location.search);
  const referredBy = params.get("ref") || null;

  // Function to generate a unique referral code
  function generateReferralCode() {
    const prefix = "CTA";
    const random = Math.floor(100000 + Math.random() * 900000);
    return `${prefix}${random}`;
  }

  async function registerReferral() {
    const name = document.getElementById('fullName').value.trim();
    const email = document.getElementById('email').value.trim().toLowerCase();
    const phone = document.getElementById('phone').value.trim();
    const password = document.getElementById('password').value;

    if (!name || !email || !phone || password.length < 6)
      return alert("Please fill all fields correctly");

    const btn = document.querySelector('.btn');
    btn.disabled = true;
    btn.textContent = "Creating Account...";

    try {
      // --------------------------
      // STEP 1: CREATE AUTH USER
      // --------------------------
      const res = await fetch(`${SUPABASE_URL}/auth/v1/signup`, {
        method: 'POST',
        headers: { 'apikey': ANON_KEY, 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, password })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.msg || data.error_description || "Signup failed");

      const userId = data.id || data.user?.id;
      const userReferralCode = generateReferralCode();

      // -----------------------------------
      // STEP 2: SAVE IN REGISTRATIONS TABLE
      // -----------------------------------
      const regRes = await fetch(`${SUPABASE_URL}/rest/v1/registrations`, {
        method: 'POST',
        headers: {
          'apikey': ANON_KEY,
          'Authorization': `Bearer ${ANON_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        },
        body: JSON.stringify({
          auth_id: userId,
          full_name: name,
          email: email,
          phone: phone,
          client_type: 'referral',
          referral_code: userReferralCode,    // your code
          referred_by: referredBy,            // the person who referred them
          payment_status: "pending"
        })
      });

      if (!regRes.ok) throw await regRes.json();

      alert("Account created successfully! Check your email to confirm.");
      location.href = 'referral-payment.html';

    } catch (err) {
      console.error(err);
      alert("Error: " + (err.message || "Please try again"));
      btn.disabled = false;
      btn.textContent = "Join & Start Earning";
    }
  }
</script>
</body>
</html>
