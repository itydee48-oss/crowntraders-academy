<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crown Trade Academy — Mentor Console</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{--nude:#F9F6F2;--gold:#C8A97E;--gold-dark:#B89463;--charcoal:#2e2e2e;--muted:#777;}
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:'Montserrat',sans-serif;background:linear-gradient(135deg,var(--nude),#fff);color:var(--charcoal);min-height:100vh;}
    .app{display:grid;grid-template-columns:280px 1fr;gap:24px;padding:24px;height:100vh;}
    .sidebar{background:rgba(255,255,255,0.92);border:1px solid rgba(200,169,126,0.4);border-radius:16px;padding:30px;box-shadow:0 20px 60px rgba(0,0,0,0.06);}
    .brand{font-family:'Cormorant Garamond',serif;font-size:2.2rem;color:var(--gold-dark);margin-bottom:8px;}
    .mentor-info{margin:20px 0;font-size:0.95rem;color:var(--muted);}
    .nav button{width:100%;padding:14px 18px;margin:8px 0;border:none;border-radius:12px;background:transparent;color:var(--charcoal);font-weight:600;text-align:left;cursor:pointer;transition:0.3s;}
    .nav button:hover,.nav button.active{background:var(--gold);color:white;}
    .main{background:rgba(255,255,255,0.95);border-radius:16px;padding:30px;overflow:auto;border:1px solid rgba(200,169,126,0.3);}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;}
    .title{font-family:'Cormorant Garamond',serif;font-size:2rem;color:var(--gold-dark);}
    .avatar{width:56px;height:56px;border-radius:50%;background:var(--gold);color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:1.6rem;}
    .card{background:white;padding:24px;border-radius:14px;margin-bottom:20px;box-shadow:0 10px 30px rgba(0,0,0,0.05);border:1px solid #eee;}
    .client-list{max-height:60vh;overflow-y:auto;}
    .client-item{display:flex;align-items:center;padding:12px;border-radius:10px;cursor:pointer;transition:0.2s;margin:6px 0;}
    .client-item:hover,.client-item.active{background:var(--gold);color:white;}
    .client-item img{width:40px;height:40px;border-radius:50%;margin-right:12px;object-fit:cover;}
    .chat{height:100%;display:flex;flex-direction:column;background:white;border-radius:14px;overflow:hidden;}
    .chat-header{padding:16px;background:var(--gold);color:white;font-weight:600;}
    .chat-window{flex:1;padding:20px;overflow-y:auto;background:#fdfaf7;}
    .msg{max-width:78%;padding:12px 16px;border-radius:18px;margin:8px 0;clear:both;}
    .msg.sent{background:var(--gold);color:white;margin-left:auto;}
    .msg.recv{background:#f0f0f0;color:var(--charcoal);}
    .chat-form{display:flex;padding:16px;background:white;border-top:1px solid #eee;}
    .chat-form input{flex:1;padding:14px;border-radius:12px;border:1px solid #ddd;margin-right:10px;}
    .btn{background:var(--gold);color:white;border:none;padding:14px 20px;border-radius:12px;cursor:pointer;font-weight:700;}
    #tradingview{height:460px;border-radius:12px;overflow:hidden;margin-top:20px;}
    @media(max-width:1000px){.app{grid-template-columns:1fr;}}
  </style>
</head>
<body>

<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">Crown Trade</div>
    <div class="mentor-info">
      <div id="mentorName" style="font-weight:700;">Loading...</div>
      <div id="mentorEmail" style="color:var(--muted);font-size:0.9rem;">—</div>
    </div>
    <nav class="nav">
      <button data-tab="clients" class="active">Clients</button>
      <button data-tab="lessons">Lessons</button>
      <button data-tab="profile">Profile</button>
    </nav>
    <button class="btn" style="margin-top:30px;width:100%;" id="btnLogout">Logout</button>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <div class="title">Mentor Console</div>
      <div style="display:flex;align-items:center;gap:14px;">
        <div class="avatar" id="avatarInitials">M</div>
        <div><div id="topName" style="font-weight:700;">Mentor</div><small id="topEmail">—</small></div>
      </div>
    </div>

    <!-- Clients Tab -->
    <div id="clients" style="display:block;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:30px;height:calc(100% - 100px);">
        <div class="card client-list" id="clientList">
          <h3 style="margin-bottom:16px;color:var(--gold-dark);">Your Shared Clients</h3>
          <div style="color:#888;">Loading clients...</div>
        </div>
        <div class="chat">
          <div class="chat-header" id="chatHeader">Select a client to start chatting</div>
          <div class="chat-window" id="chatWindow"></div>
          <form class="chat-form" id="chatForm">
            <input type="text" id="messageInput" placeholder="Type your message..." disabled>
            <button type="submit" class="btn" disabled>Send</button>
          </form>
        </div>
      </div>
      <div id="tradingview"></div>
    </div>

    <!-- Lessons Tab -->
    <div id="lessons" class="card" style="display:none;">
      <h2>Upload Lesson</h2>
      <input placeholder="Title" id="lessonTitle" style="width:100%;padding:14px;margin:10px 0;border-radius:12px;border:1px solid #ddd;">
      <input placeholder="File URL" id="lessonUrl" style="width:100%;padding:14px;margin:10px 0;border-radius:12px;border:1px solid #ddd;">
      <button class="btn" id="uploadLesson">Upload</button>
    </div>

    <!-- Profile Tab -->
    <div id="profile" class="card" style="display:none;text-align:center;">
      <img id="profilePreview" src="https://i.imgur.com/8QjW9jF.jpeg" width="120" style="border-radius:50%;border:5px solid var(--gold);">
      <br><br>
      <input type="file" id="photoUpload" accept="image/*" style="display:none;">
      <button class="btn" onclick="document.getElementById('photoUpload').click()">Change Photo</button>
      <br><br>
      <input placeholder="Username" id="profileUsername" style="width:100%;padding:14px;border-radius:12px;">
      <input placeholder="Email" id="profileEmail" style="width:100%;padding:14px;border-radius:12px;margin-top:10px;">
      <button class="btn" id="saveProfile" style="margin-top:20px;">Save Profile</button>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://s3.tradingview.com/tv.js"></script>
<script>
const SUPABASE_URL = 'https://eygjxxdgxzatchqgwvep.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5Z2p4eGRneHphdGNoUWd3dmVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzODUyODIsImV4cCI6MjA3Nzk2MTI4Mn0.USOvTWBQ_kW-ty5XkTehYmPJKXeD2_hGGGM40G55tqg';

const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentUser = null;
let currentClientId = null;

async function init() {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session) {
    location.href = 'login.html';
    return;
  }

  currentUser = session.user;

  const { data: profile, error } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', currentUser.id)
    .single();

  if (error || !profile || profile.role !== 'mentor') {
    location.href = 'login.html';
    return;
  }

  document.getElementById('mentorName').textContent = profile.username || profile.email;
  document.getElementById('topName').textContent = profile.username || 'Mentor';
  document.getElementById('topEmail').textContent = profile.email;
  document.getElementById('avatarInitials').textContent = (profile.username || 'M').slice(0,2).toUpperCase();
  document.getElementById('profileUsername').value = profile.username || '';
  document.getElementById('profileEmail').value = profile.email;
  if (profile.avatar_url) document.getElementById('profilePreview').src = profile.avatar_url;

  loadClients();
  loadTradingView();
}

async function loadClients() {
  const { data: assignments, error } = await supabase
    .from('mentor_assignments')
    .select('client_id')
    .eq('mentor_id', currentUser.id);

  if (error || !assignments || assignments.length === 0) {
    document.getElementById('clientList').innerHTML = '<div>No clients assigned yet.</div>';
    return;
  }

  const clientIds = assignments.map(a => a.client_id);
  
  const { data: clients, error: clientsError } = await supabase
    .from('profiles')
    .select('id, username, email, avatar_url')
    .in('id', clientIds);

  if (clientsError || !clients) {
    document.getElementById('clientList').innerHTML = '<div>Error loading clients</div>';
    return;
  }

  document.getElementById('clientList').innerHTML = clients.map(c => `
    <div class="client-item" onclick="openChat('${c.id}', '${c.username || c.email}')">
      ${c.avatar_url ? `<img src="${c.avatar_url}">` : '<div style="width:40px;height:40px;background:#ddd;border-radius:50%;margin-right:12px;"></div>'}
      <div><strong>${c.username || c.email}</strong></div>
    </div>
  `).join('');
}

window.openChat = async (clientId, name) => {
  currentClientId = clientId;
  document.querySelectorAll('.client-item').forEach(el => el.classList.remove('active'));
  event.target.closest('.client-item').classList.add('active');
  document.getElementById('chatHeader').textContent = `Chat with ${name}`;
  document.getElementById('messageInput').disabled = false;
  document.querySelector('#chatForm button').disabled = false;
  document.getElementById('chatWindow').innerHTML = '';
  loadMessages();
};

async function loadMessages() {
  const { data: msgs, error } = await supabase
    .from('messages')
    .select('*')
    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${currentClientId}),and(sender_id.eq.${currentClientId},receiver_id.eq.${currentUser.id})`)
    .order('created_at', { ascending: true });

  if (error) return;

  document.getElementById('chatWindow').innerHTML = msgs.map(m => `
    <div class="msg ${m.sender_id === currentUser.id ? 'sent' : 'recv'}">${m.message}</div>
  `).join('');
  document.getElementById('chatWindow').scrollTop = document.getElementById('chatWindow').scrollHeight;
}

document.getElementById('chatForm').onsubmit = async (e) => {
  e.preventDefault();
  const input = document.getElementById('messageInput');
  const msg = input.value.trim();
  if (!msg) return;
  
  const { error } = await supabase
    .from('messages')
    .insert([{ sender_id: currentUser.id, receiver_id: currentClientId, message: msg }]);

  if (!error) {
    input.value = '';
    loadMessages();
  }
};

// Tab switching - FIXED VERSION
document.querySelectorAll('.nav button').forEach(b => {
  b.onclick = () => {
    document.querySelectorAll('.nav button').forEach(x => x.classList.remove('active'));
    b.classList.add('active');
    document.querySelectorAll('#clients, #lessons, #profile').forEach(d => {
      d.style.display = 'none';
    });
    document.getElementById(b.dataset.tab).style.display = 'block';
  };
});

document.getElementById('btnLogout').onclick = async () => {
  await supabase.auth.signOut();
  location.href = 'login.html';
};

function loadTradingView() {
  if (typeof TradingView !== 'undefined') {
    new TradingView.widget({
      container_id: "tradingview",
      width: "100%",
      height: 460,
      symbol: "BINANCE:BTCUSDT",
      interval: "60",
      theme: "light",
      style: "1",
      locale: "en",
      toolbar_bg: "#f1f3f6",
      enable_publishing: false,
      allow_symbol_change: true,
      details: true,
      hotlist: true,
      calendar: true,
      studies: [
        "BB@tv-basicstudies",
        "RSI@tv-basicstudies"
      ]
    });
  }
}

// Initialize the dashboard
init();

// Auto-refresh messages every 4 seconds if a client is selected
setInterval(() => {
  if (currentClientId) loadMessages();
}, 4000);
</script>
</body>
</html>
