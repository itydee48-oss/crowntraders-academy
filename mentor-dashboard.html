<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crown Trade • Mentor Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <style>
    :root{--gold:#c8a97e;--gold-dark:#b89463;--nude:#f9f6f2;--charcoal:#1a1a1a;--soft:#fdfcfb;--border:rgba(200,169,126,0.18)}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:var(--nude);color:var(--charcoal);min-height:100vh}
    .container{max-width:1700px;margin:0 auto;padding:2rem}
    .header{background:linear-gradient(135deg,#0a0a0a,#1a1a1a);color:white;padding:4rem 2rem;border-radius:32px;text-align:center;margin-bottom:3rem}
    .header h1{font-family:'Cormorant Garamond',serif;font-size:5.5rem;letter-spacing:-2px}
    .mentor-badge{background:linear-gradient(90deg,var(--gold),var(--gold-dark));padding:0.8rem 2.2rem;border-radius:50px;font-weight:800;font-size:1.3rem;margin-top:1rem;display:inline-block}
    .grid{display:grid;grid-template-columns:1fr 460px;gap:3rem}
    .card{background:var(--soft);border:1px solid var(--border);border-radius:24px;padding:2.5rem;box-shadow:0 25px 70px rgba(0,0,0,0.08);margin-bottom:2rem}
    .section-title{font-family:'Cormorant Garamond',serif;font-size:2.8rem;color:var(--gold-dark);margin-bottom:2rem}
    .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:1.8rem;margin-bottom:3rem}
    .stat{background:white;padding:2rem;border-radius:20px;text-align:center;box-shadow:0 15px 40px rgba(0,0,0,0.06)}
    .stat-num{font-size:3.8rem;font-weight:800;color:var(--gold-dark);font-family:'Cormorant Garamond'}
    .upload-zone{border:3px dashed var(--gold);border-radius:20px;padding:4rem;text-align:center;cursor:pointer;margin-bottom:2rem}
    .upload-zone:hover{background:var(--gold);color:white}
    .clients-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:2rem}
    .client-card{background:white;padding:2rem;border-radius:20px;box-shadow:0 15px 40px rgba(0,0,0,0.05)}
    .client-card.premium{border:2px solid var(--gold)}
    .chat-container{height:780px;display:flex;flex-direction:column;background:white;border-radius:24px;overflow:hidden;box-shadow:0 25px 70px rgba(0,0,0,0.1)}
    .chat-header{background:linear-gradient(90deg,var(--gold),var(--gold-dark));color:white;padding:2rem;text-align:center}
    .chat-messages{flex:1;padding:2rem;overflow-y:auto;background:#f8f5f0}
    .message{margin-bottom:1.5rem;max-width:78%}
    .message.sent{margin-left:auto}
    .message-bubble{padding:16px 22px;border-radius:24px;font-size:1.05rem}
    .message.sent .message-bubble{background:var(--gold);color:white}
    .chat-input{padding:2rem;background:white;border-top:1px solid var(--border);display:flex;gap:16px}
    .chat-input input{flex:1;padding:18px 24px;border-radius:50px;border:1px solid var(--border)}
    .btn-send{background:var(--gold);color:white;border:none;width:60px;height:60px;border-radius:50%;cursor:pointer;font-size:1.6rem}
    .logout{position:fixed;bottom:30px;right:30px;background:#ef4444;color:white;padding:16px 32px;border-radius:50px;font-weight:700;cursor:pointer;box-shadow:0 10px 30px rgba(239,68,68,0.4);z-index:100}
  </style>
</head>
<body>

<script>
  if (localStorage.getItem('mentor_logged_in') !== 'true') {
    window.location.href = 'mentor-login.html';
  }
</script>

<div class="container">
  <div class="header">
    <h1>Crown Trade Academy</h1>
    <p>Elite Forex & Synthetic Indices Mentorship</p>
    <div class="mentor-badge">Crown Mentor</div>
  </div>

  <div class="stats">
    <div class="stat"><div class="stat-num" id="totalClients">0</div><div>Total Clients</div></div>
    <div class="stat"><div class="stat-num" id="mentorshipCount">0</div><div>Mentorship</div></div>
    <div class="stat"><div class="stat-num" id="referralCount">0</div><div>Referral</div></div>
    <div class="stat"><div class="stat-num" id="totalRevenue">KSh 0</div><div>Revenue</div></div>
  </div>

  <div class="grid">
    <div>
      <!-- Upload Lessons -->
      <div class="card">
        <h2 class="section-title">Upload Lessons (Videos & PDFs)</h2>
        <div class="upload-zone" id="dropZone">
          <i class="fas fa-cloud-upload-alt" style="font-size:4rem;color:var(--gold);margin-bottom:1rem;"></i>
          <p><strong>Drag & drop files here</strong></p>
          <input type="file" id="fileInput" multiple accept="video/*,.pdf" style="display:none">
        </div>
        <div id="uploadStatus"></div>
      </div>

      <!-- Approved Clients -->
      <div class="card">
        <h2 class="section-title">Approved Elite Clients</h2>
        <div class="clients-grid" id="clientsList">
          Loading clients...
        </div>
      </div>
    </div>

    <!-- Chat -->
    <div>
      <div class="chat-container">
        <div class="chat-header">
          <h3>Mentor Team Chat</h3>
          <small>All 4 mentors • Real-time</small>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="Type message...">
          <button class="btn-send" onclick="sendChat()">Send</button>
        </div>
      </div>
    </div>
  </div>
</div>

<button class="logout" onclick="localStorage.clear();location.href='mentor-login.html'">Logout</button>

<!-- SUPABASE CONNECTION -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabase = window.supabase.createClient(
    'https://omrsywvfdhzeokmfdrfh.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tcnN5d3ZmZGh6ZW9rbWZkcmZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjAxOTUsImV4cCI6MjA3OTkzNjE5NX0.MaIrC_r3kfgtsNEeGmRCRV7q2_k14sIR7z87OLVSN0o'
  );

  // Load Clients
  async function loadClients() {
    const { data, error } = await supabase
      .from('registrations')
      .select('*')
      .eq('payment_status', 'approved')
      .order('created_at', { ascending: false });

    if (error) return console.error(error);

    document.getElementById('totalClients').textContent = data.length;
    document.getElementById('mentorshipCount').textContent = data.filter(c => c.client_type === 'mentorship').length;
    document.getElementById('referralCount').textContent = data.filter(c => c.client_type === 'referral').length;
    document.getElementById('totalRevenue').textContent = 'KSh ' + data.reduce((a,c) => a + (c.amount_paid || 0), 0).toLocaleString();

    const list = document.getElementById('clientsList');
    list.innerHTML = data.map(c => `
      <div class="client-card ${c.client_type === 'mentorship' ? 'premium' : ''}">
        <div style="font-size:1.5rem;font-weight:700">${c.full_name}</div>
        <div style="margin:0.5rem 0;color:#666">${c.email} • ${c.phone}</div>
        <div style="background:var(--gold);color:white;padding:0.4rem 1rem;border-radius:50px;display:inline-block;font-size:0.9rem">
          ${c.client_type.toUpperCase()} • KSh ${c.amount_paid?.toLocaleString()}
        </div>
        <div style="margin-top:0.5rem;color:#888;font-size:0.9rem">
          Joined ${new Date(c.created_at).toLocaleDateString()}
        </div>
      </div>
    `).join('');
  }

  // Upload Files
  const dropZone = document.getElementById('dropZone');
  dropZone.onclick = () => document.getElementById('fileInput').click();
  dropZone.ondrop = e => { e.preventDefault(); uploadFiles(e.dataTransfer.files); };
  dropZone.ondragover = e => e.preventDefault();
  document.getElementById('fileInput').onchange = e => uploadFiles(e.target.files);

  async function uploadFiles(files) {
    for (let file of files) {
      const fileName = `${Date.now()}_${file.name}`;
      const { error } = await supabase.storage
        .from('lessons')
        .upload(fileName, file);

      if (error) alert('Upload failed: ' + error.message);
      else document.getElementById('uploadStatus').innerHTML += `<p>Uploaded: ${file.name}</p>`;
    }
    alert('All files uploaded!');
  }

  // Real-time Chat
  const channel = supabase.channel('mentor-chat');
  channel
    .on('broadcast', { event: 'message' }, ({ payload }) => {
      const div = document.createElement('div');
      div.className = payload.self ? 'message sent' : 'message received';
      div.innerHTML = `<div class="message-bubble">${payload.msg}</div>`;
      document.getElementById('chatMessages').appendChild(div);
      div.scrollIntoView();
    })
    .subscribe();

  function sendChat() {
    const input = document.getElementById('chatInput');
    const msg = input.value.trim();
    if (!msg) return;
    channel.send({
      type: 'broadcast',
      event: 'message',
      payload: { msg, self: true }
    });
    input.value = '';
  }

  // Load on start
  loadClients();
</script>
</body>
</html>
