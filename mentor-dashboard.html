<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crown Trade Academy — Mentor Dashboard</title>
  <meta name="description" content="Shared dashboard for all 4 mentors">

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

  <!-- FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --gold: #c8a97e;
      --gold-dark: #b89463;
      --nude: #f9f6f2;
      --charcoal: #2a2a2a;
      --gray: #666;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font-family:'Montserrat',sans-serif;background:#f5f2ed;color:var(--charcoal);min-height:100vh;}
    .container{max-width:1400px;margin:0 auto;padding:20px;}
    .header{background:linear-gradient(135deg,var(--gold),var(--gold-dark));color:white;padding:1.5rem;border-radius:16px;margin-bottom:2rem;text-align:center;}
    .header h1{font-family:'Cormorant Garamond',serif;font-size:2.8rem;}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:24px;}
    .main-card{background:white;border-radius:16px;padding:2rem;box-shadow:0 10px 40px rgba(0,0,0,0.08);margin-bottom:2rem;}
    .section-title{font-family:'Cormorant Garamond',serif;font-size:1.8rem;color:var(--gold-dark);margin-bottom:1rem;border-bottom:2px solid var(--gold);padding-bottom:0.5rem;}
    .btn{background:var(--gold);color:white;border:none;padding:12px 24px;border-radius:50px;font-weight:600;cursor:pointer;transition:0.3s;}
    .btn:hover{background:var(--gold-dark);transform:translateY(-2px);}
    .btn-small{padding:8px 16px;font-size:0.9rem;}
    .upload-box{border:3px dashed var(--gold);border-radius:16px;padding:3rem;text-align:center;cursor:pointer;transition:0.3s;background:#fdfbf8;}
    .upload-box:hover{background:#f5f0e8;}
    .file-list{margin-top:1rem;}
    .file-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:#f9f6f2;border-radius:12px;margin-bottom:8px;}
    .calendar{height:600px;margin-top:1rem;}
    .chat-box{background:#fff;border-radius:16px;height:600px;display:flex;flex-direction:column;box-shadow:0 8px 30px rgba(0,0,0,0.06);}
    .chat-header{background:var(--gold);color:white;padding:1rem;text-align:center;font-weight:600;}
    .chat-messages{flex:1;padding:1rem;overflow-y:auto;background:#f8f5f0;}
    .msg{padding:10px 16px;border-radius:18px;margin-bottom:10px;max-width:75%;word-wrap:break-word;}
    .msg.sent{background:var(--gold);color:white;margin-left:auto;}
    .msg.received{background:#e5e7eb;color:black;}
    .chat-input{display:flex;padding:1rem;background:white;border-top:1px solid #eee;}
    .chat-input input{flex:1;padding:12px;border-radius:50px;border:1px solid #ddd;margin-right:10px;}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin:2rem 0;}
    .stat-card{background:white;padding:1.5rem;border-radius:16px;text-align:center;box-shadow:0 8px 25px rgba(0,0,0,0.05);}
    .stat-card .num{font-size:2.5rem;font-weight:800;color:var(--gold-dark);font-family:'Cormorant Garamond';}
    @media(max-width:1024px){
      .grid{grid-template-columns:1fr;}
      .chat-box,.calendar{height:500px;}
    }
  </style>
</head>
<body>

<div class="container">
  <!-- Header -->
  <div class="header">
    <h1>Crown Trade Academy</h1>
    <p style="font-size:1.3rem;margin-top:0.5rem;">Shared Mentor Dashboard — Luxury Trading Education</p>
    <div style="margin-top:1rem;">
      <span style="background:rgba(255,255,255,0.2);padding:8px 20px;border-radius:50px;" id="mentorName">Loading mentor...</span>
    </div>
  </div>

  <div class="grid">
    <!-- Main Area -->
    <div>
      <!-- Stats -->
      <div class="stats">
        <div class="stat-card">
          <div class="num" id="totalClients">0</div>
          <div>Total Clients</div>
        </div>
        <div class="stat-card">
          <div class="num" id="activeToday">0</div>
          <div>Active Today</div>
        </div>
        <div class="stat-card">
          <div class="num" id="pendingPayments">0</div>
          <div>Pending Payments</div>
        </div>
        <div class="stat-card">
          <div class="num" id="totalEarnings">KSh 0</div>
          <div>Total Earnings</div>
        </div>
      </div>

      <!-- Upload Lessons -->
      <div class="main-card">
        <h2 class="section-title">Upload Lessons (Videos & PDFs)</h2>
        <div class="upload-box" id="dropZone">
          <i class="fas fa-cloud-upload-alt" style="font-size:4rem;color:var(--gold);margin-bottom:1rem;"></i>
          <p><strong>Drag & drop files here or click to browse</strong></p>
          <p style="color:#777;margin-top:0.5rem;">MP4, PDF, up to 500MB</p>
          <input type="file" id="fileInput" accept="video/*,.pdf" multiple style="display:none;">
        </div>
        <div id="uploadStatus" style="margin-top:1rem;"></div>

        <h3 style="margin-top:2rem;color:var(--gold-dark);">Current Lessons</h3>
        <div class="file-list" id="lessonsList">
          Loading your lessons...
        </div>
      </div>

      <!-- Schedule -->
      <div class="main-card" style="margin-top:2rem;">
        <h2 class="section-title">Mentor Schedule & Zoom Links</h2>
        <div id="calendar" class="calendar"></div>
      </div>
    </div>

    <!-- Sidebar Chat -->
    <div>
      <div class="chat-box">
        <div class="chat-header">
          <div>Mentor Group Chat</div>
          <small>All 4 mentors + admin</small>
        </div>
        <div class="chat-messages" id="chatMessages">
          <div class="msg received">Welcome to the mentor console</div>
        </div>
        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="Type a message...">
          <button class="btn btn-small" id="sendBtn">Send</button>
        </div>
      </div>

      <div class="main-card" style="margin-top:1.5rem;text-align:center;">
        <h3>Quick Actions</h3>
        <button class="btn" style="margin:0.5rem;" onclick="location.href='admin-approvals.html'">Approve Payments</button>
        <button class="btn" style="margin:0.5rem;background:#10b981;" onclick="alert('Broadcast feature coming soon')">Broadcast to All Clients</button>
        <button class="btn" style="margin:0.5rem;background:#ef4444" onclick="supabase.auth.signOut()">Logout</button>
      </div>
    </div>
  </div>
</div>

<script>
// === SUPABASE SETUP ===
const supabase = window.supabase.createClient(
  'https://omrsywvfdhzeokmfdrfh.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tcnN5d3ZmZGh6ZW9rbWZkcmZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjAxOTUsImV4cCI6MjA3OTkzNjE5NX0.MaIrC_r3kfgtsNEeGmRCRV7q2_k14sIR7z87OLVSN0o'
);

let currentMentor = null;

// === AUTH CHECK ===
async function initAuth() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return location.href = 'mentor-login.html';

  const { data: profile } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', user.id)
    .single();

  if (profile?.role !== 'mentor') {
    alert('Access denied');
    return location.href = 'index.html';
  }

  currentMentor = profile;
  document.getElementById('mentorName').textContent = profile.full_name || 'Mentor';
  loadDashboard();
}

initAuth();

// === LOAD DASHBOARD DATA ===
async function loadDashboard() {
  // Stats
  const { count: clients } = await supabase.from('registrations').select('*', { count: 'exact' });
  document.getElementById('totalClients').textContent = clients || 0;

  // Lessons list
  const { data: lessons } = await supabase.storage.from('lessons').list('', { limit: 100 });
  const list = document.getElementById('lessonsList');
  list.innerHTML = '';
  lessons?.forEach(file => {
    const url = supabase.storage.from('lessons').getPublicUrl(file.name).data.publicUrl;
    const item = document.createElement('div');
    item.className = 'file-item';
    item.innerHTML = `
      <div><strong>${file.name}</strong></div>
      <div>
        <a href="${url}" target="_blank" style="color:var(--gold);margin-right:12px;">View</a>
        <button onclick="deleteFile('${file.name}')" style="color:red;">Delete</button>
      </div>
    `;
    list.appendChild(item);
  });
}

// === FILE UPLOAD ===
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

dropZone.onclick = () => fileInput.click();
fileInput.onchange = e => uploadFiles(e.target.files);

dropZone.ondragover = e => { e.preventDefault(); dropZone.style.background = '#f0e6d2'; };
dropZone.ondragleave = () => dropZone.style.background = '#fdfbf8';
dropZone.ondrop = e => {
  e.preventDefault();
  dropZone.style.background = '#fdfbf8';
  uploadFiles(e.dataTransfer.files);
};

async function uploadFiles(files) {
  if (!files.length) return;
  document.getElementById('uploadStatus').textContent = 'Uploading...';

  for (file of files) {
    const fileName = `${Date.now()}_${file.name}`;
    const { error } = await supabase.storage
      .from('lessons')
      .upload(fileName, file);

    if (error) {
      console.error(error);
      alert('Upload failed: ' + file.name);
    }
  }

  document.getElementById('uploadStatus').textContent = 'Upload complete!';
  setTimeout(loadDashboard, 2000);
}

async function deleteFile(fileName) {
  if (!confirm('Delete this file?')) return;
  await supabase.storage.from('lessons').remove([fileName]);
  loadDashboard();
}

// === FULLCALENDAR ===
document.addEventListener('DOMContentLoaded', function() {
  var calendarEl = document.getElementById('calendar');
  var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
    events: [
      { title: 'Mentor Call - John', start: new Date(), backgroundColor: var(--gold) },
      { title: 'Group Session', start: new Date().setHours(Date().getHours()+48), backgroundColor: '#10b981' }
    ],
    editable: true,
    selectable: true
  });
  calendar.render();
});

// === SIMPLE CHAT (mentor group) ===
const chatMessages = document.getElementById('chatMessages');
const chatInput = document.getElementById('chatInput');

supabase
  .channel('mentor-chat')
  .on('broadcast', { event: 'message' }, ({ payload }) => {
    const msg = document.createElement('div');
    msg.className = 'msg ' + (payload.self ? 'sent' : 'received');
    msg.textContent = payload.message;
    chatMessages.appendChild(msg);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  })
  .subscribe();

document.getElementById('sendBtn').onclick = () => {
  const text = chatInput.value.trim();
  if (!text) return;
  supabase.channel('mentor-chat').send({
    type: 'broadcast',
    event: 'message',
    message: text,
    self: true
  });
  chatInput.value = '';
};
  </script>
</body>
</html>
