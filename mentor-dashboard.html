<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crown Trade • Mentor Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--gold:#c8a97e;--gold-dark:#b89463;--charcoal:#1a1a1a;--nude:#f9f6f2;--soft:#fdfcfb;--border:rgba(200,169,126,0.2)}
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Inter',sans-serif;background:var(--nude);color:var(--charcoal;line-height:1.6}
    .container{max-width:1600px;margin:0 auto;padding:2rem}
    .header{background:linear-gradient(135deg,#0a0a0a,#1a1a1a);color:white;padding:4rem 2rem;border-radius:32px;text-align:center;margin-bottom:3rem}
    .header h1{font-family:'Cormorant Garamond',serif;font-size:5rem;letter-spacing:-2px}
    .badge{background:linear-gradient(90deg,var(--gold),var(--gold-dark));padding:0.8rem 2rem;border-radius:50px;font-weight:700;display:inline-block;margin-top:1rem}
    .grid{display:grid;grid-template-columns:1fr 480px;gap:3rem}
    .card{background:var(--soft);border:1px solid var(--border);border-radius:24px;padding:2.5rem;box-shadow:0 20px 60px rgba(0,0,0,0.08);margin-bottom:2rem}
    .title{font-family:'Cormorant Garamond',serif;font-size:2.6rem;color:var(--gold-dark);margin-bottom:2rem}
    .btn{background:var(--gold);color:white;border:none;padding:14px 28px;border-radius:50px;font-weight:600;cursor:pointer;transition:.3s}
    .btn:hover{background:var(--gold-dark);transform:translateY(-3px)}
    .input{padding:14px 20px;border:1px solid var(--border);border-radius:16px;width:100%;margin:10px 0}
    table{width:100%;border-collapse:collapse;margin-top:1rem}
    th,td{padding:16px;text-align:left;border-bottom:1px solid var(--border)}
    th{background:var(--soft);font-weight:600}
    tr:hover{background:#f5f0e8}
    .tab-btn{background:transparent;border:none;padding:12px 24px;border-radius:50px;font-weight:600;cursor:pointer;margin-right:1rem}
    .tab-btn.active{background:var(--gold);color:white}
    .hidden{display:none}
    .logout{position:fixed;bottom:30px;right:30px;background:#ef4444;color:white;padding:16px 32px;border-radius:50px;font-weight:700;cursor:pointer;box-shadow:0 10px 30px rgba(239,68,68,0.4);z-index:100}
  </style>
</head>
<body>

<script>
  if (localStorage.getItem('mentor_logged_in') !== 'true') {
    window.location.href = 'mentor-login.html';
  }
</script>

<div class="container">
  <div class="header">
    <h1>Crown Trade Academy</h1>
    <p>Mentor Portal • Simple. Powerful. Elite.</p>
    <div class="badge">Active Mentor</div>
  </div>

  <!-- Tabs -->
  <div style="margin-bottom:2rem">
    <button class="tab-btn active onclick="show('clients')">Clients</button>
    <button class="tab-btn" onclick="show('resources')">Resources Library</button>
    <button class="tab-btn" onclick="show('tasks')">Study Tasks</button>
    <button class="tab-btn" onclick="show('sessions')">Sessions & Calls</button>
  </div>

  <div class="grid">
    <!-- MAIN -->
    <div>
      <!-- CLIENTS LIST -->
      <div id="clients" class="card">
        <h2 class="title">Approved Clients</h2>
        <input type="text" id="search" placeholder="Search by name, email, phone..." class="input" onkeyup="searchClients()">
        <table id="clientsTable">
          <thead><tr><th>Name</th><th>Phone</th><th>Email</th><th>Program</th><th>Joined</th><th>Action</th></tr></thead>
          <tbody id="clientsBody">Loading...</tbody>
        </table>
      </div>

      <!-- CLIENT DETAILS (hidden until clicked) -->
      <div id="clientDetails" class="card hidden">
        <button onclick="show('clients')" style="margin-bottom:1rem;color:var(--gold)">← Back to List</button>
        <h2 class="title" id="detailName">Client Name</h2>
        <p><strong>Email:</strong> <span id="detailEmail"></span></p>
        <p><strong>Phone:</strong> <span id="detailPhone"></span></p>
        <p><strong>Program:</strong> <span id="detailProgram"></span></p>

        <h3 style="margin:2rem 0 1rem">Add Task</h3>
        <textarea class="input" id="newTask" placeholder="e.g. Watch Module 3 + submit backtest by Friday"></textarea>
        <button class="btn" onclick="addTask()">Assign Task</button>

        <h3 style="margin:2rem 0 1rem">Mentor Notes</h3>
        <textarea class="input" id="mentorNote" placeholder="Private notes about this student..."></textarea>
        <button class="btn" onclick="saveNote()">Save Note</button>

        <h3 style="margin:2rem 0 1rem">Send Zoom Link</h3>
        <input type="text" class="input" id="zoomLink" placeholder="Paste Zoom/Google Meet link">
        <button class="btn" onclick="sendLink()">Send Call Link</button>
      </div>

      <!-- RESOURCES -->
      <div id="resources" class="card hidden">
        <h2 class="title">Resources Library</h2>
        <input type="file" id="resourceFile" multiple accept=".pdf,video/*" style="display:none">
        <input type="text" class="input" id="resourceTitle" placeholder="Title (e.g. ICT Mentorship 2024 Full Course)">
        <button class="btn" onclick="document.getElementById('resourceFile').click()">Choose Files</button>
        <button class="btn" onclick="uploadResource()">Upload to Library</button>
        <div id="resourceList" style="margin-top:2rem"></div>
      </div>

      <!-- TASKS -->
      <div id="tasks" class="card hidden">
        <h2 class="title">All Study Tasks</h2>
        <div id="tasksList">Loading tasks...</div>
      </div>

      <!-- SESSIONS -->
      <div id="sessions" class="card hidden">
        <h2 class="title">Weekly Calls & Sessions</h2>
        <textarea class="input" id="sessionInfo" placeholder="e.g. Weekly Group Call - Every Saturday 8PM EAT"></textarea>
        <input type="text" class="input" id="sessionLink" placeholder="Zoom Link">
        <button class="btn" onclick="publishSession()">Publish Session</button>
        <div id="sessionList" style="margin-top:2rem"></div>
      </div>
    </div>

    <!-- SIDEBAR CHAT -->
    <div>
      <div class="card" style="height:800px;display:flex;flex-direction:column">
        <div style="background:var(--gold);color:white;padding:1.5rem;text-align:center;border-radius:24px 24px 0 0">
          <h3>Mentor Team Chat</h3>
        </div>
        <div id="chatMessages" style="flex:1;overflow-y:auto;padding:2rem;background:#f8f5f0"></div>
        <div style="padding:1.5rem;border-top:1px solid var(--border);display:flex;gap:gap:1rem">
          <input type="text" id="chatInput" placeholder="Message team..." style="flex:1" onkeypress="if(event.key==='Enter')sendChat()">
          <button class="btn" onclick="sendChat()">Send</button>
        </div>
      </div>
    </div>
    </div>
  </div>
</div>

<button class="logout" onclick="localStorage.clear();location.href='mentor-login.html'">Logout</button>

<script>
  const supabase = window.supabase.createClient(
    'https://omrsywvfdhzeokmfdrfh.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9tcnN5d3ZmZGh6ZW9rbWZkcmZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjAxOTUsImV4cCI6MjA3OTkzNjE5NX0.MaIrC_r3kfgtsNEeGmRCRV7q2_k14sIR7z87OLVSN0o'
  );

  let currentClientId = null;

  // Tabs
  function show(tab) {
    document.querySelectorAll('#clients,#resources,#tasks,#sessions,#clientDetails').forEach(el => el.classList.add('hidden'));
    document.getElementById(tab).classList.remove('hidden');
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    if (tab === 'clients') loadClients();
    if (tab === 'resources') loadResources();
    if (tab === 'tasks') loadTasks();
    if (tab === 'sessions') loadSessions();
  }

  // Load Clients
  async function loadClients() {
    const { data } = await supabase
      .from('registrations')
      .select('*')
      .eq('payment_status', 'approved')
      .order('created_at', { ascending: false });

    const tbody = document.getElementById('clientsBody');
    tbody.innerHTML = data.map(c => `
      <tr style="cursor:pointer" onclick="openClient(${c.id},'${c.full_name}','${c.email}','${c.phone}','${c.client_type}')">
        <td><strong>${c.full_name}</strong></td>
        <td>${c.phone}</td>
        <td>${c.email}</td>
        <td style="text-transform:capitalize">${c.client_type}</td>
        <td>${new Date(c.created_at).toLocaleDateString()}</td>
        <td><button class="btn" style="padding:8px 16px;font-size:0.9rem">Open</button></td>
      </tr>
    `).join('');
  }

  // Open Client Details
  function openClient(id, name, email, phone, program) {
    currentClientId = id;
    document.getElementById('detailName').textContent = name;
    document.getElementById('detailEmail').textContent = email;
    document.getElementById('detailPhone').textContent = phone;
    document.getElementById('detailProgram').textContent = program;
    show('clientDetails');
  }

  // Add Task
  async function addTask() {
    const task = document.getElementById('newTask').value.trim();
    if (!task || !currentClientId) return alert('Add task text');
    await supabase.from('tasks').insert({ client_id: currentClientId, task, status: 'pending' });
    alert('Task assigned!');
    document.getElementById('newTask').value = '';
  }

  // Upload Resource
  async function uploadResource() {
    const fileInput = document.getElementById('resourceFile');
    const title = document.getElementById('resourceTitle').value;
    if (!fileInput.files[0] || !title) return alert('Add title + file');

    const file = fileInput.files[0];
    const fileName = `${Date.now()}_${file.name}`;
    await supabase.storage.from('resources').upload(fileName, file);
    const { data: url } = supabase.storage.from('resources').getPublicUrl(fileName);

    await supabase.from('resources').insert({ title, file_url: url.publicUrl });
    alert('Uploaded!');
    loadResources();
  }

  async function loadResources() {
    const { data } = await supabase.from('resources').select().order('created_at', { ascending: false });
    document.getElementById('resourceList').innerHTML = data.map(r => `
      <div style="padding:1rem;background:white;border-radius:16px;margin-bottom:1rem">
        <strong>${r.title}</strong><br>
        <a href="${r.file_url}" target="_blank" style="color:var(--gold)">Open File →</a>
      </div>
    `).join('');
  }

  // Real-time Chat
  const channel = supabase.channel('mentor-chat');
  channel.on('broadcast', { event: 'msg' }, ({ payload }) => {
    const div = document.createElement('div');
    div.innerHTML = `<strong>${payload.name}:</strong> ${payload.text}`;
    div.style.marginBottom = '1rem';
    document.getElementById('chatMessages').appendChild(div);
    div.scrollIntoView();
  }).subscribe();

  function sendChat() {
    const input = document.getElementById('chatInput');
    const text = input.value.trim();
    if (!text) return;
    channel.send({ type: 'broadcast', event: 'msg', payload: { name: 'Mentor', text } });
    input.value = '';
  }

  // Load on start
  loadClients();
  loadResources();
</script>
</body>
</html>
