<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mentor Dashboard — Crown Trade</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#F9F6F2; --gold:#C8A97E; --dark:#2e2e2e; --muted:#777;
      --card:#fff;
    }
    *{box-sizing:border-box}
    body{font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--dark);margin:0;padding:18px}
    .wrap{max-width:1100px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-weight:600;color:var(--gold);margin:0}
    .controls{display:flex;gap:10px;align-items:center}
    .btn{background:var(--gold);color:#fff;padding:8px 12px;border-radius:8px;border:none;font-weight:600;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--gold);border:1px solid rgba(0,0,0,0.06)}
    .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:18px}
    .card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.06);border:1px solid #eee}
    .card h3{margin:0;font-size:0.95rem;color:var(--muted)}
    .card .val{font-size:1.4rem;font-weight:700;color:var(--gold);margin-top:8px}
    .searchRow{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    input[type="search"]{padding:10px;border-radius:10px;border:1px solid #ddd;flex:1}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    th{background:transparent;font-weight:600;color:var(--muted)}
    .status-approved{color:green;font-weight:700}
    .no-data{text-align:center;padding:18px;color:var(--muted)}
    .grid-two{display:grid;grid-template-columns:1fr 360px;gap:12px}
    @media(max-width:920px){ .grid-two{grid-template-columns:1fr} .stats{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))} }
    .resource-list{max-height:300px;overflow:auto}
    .small{font-size:0.9rem;color:var(--muted)}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:999}
    .modal.open{display:flex}
    .modal .box{background:#fff;padding:16px;border-radius:10px;max-width:90%;max-height:90%;overflow:auto}
    .note{background:#F6F9FF;padding:10px;border-radius:8px;border:1px solid #e6eefc}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Mentor Panel — Crown Trade</h1>
      <div class="controls">
        <button class="btn" id="btn-refresh">Refresh</button>
        <button class="btn secondary" id="btn-login-info">Config</button>
      </div>
    </header>

    <section class="stats">
      <div class="card">
        <h3>Total Approved Clients</h3>
        <div class="val" id="stat-count">—</div>
        <div class="small">Only approved clients shown here</div>
      </div>
      <div class="card">
        <h3>Today's New</h3>
        <div class="val" id="stat-today">—</div>
        <div class="small">Approved today</div>
      </div>
      <div class="card">
        <h3>Search</h3>
        <div class="small">Use the search box below</div>
      </div>
    </section>

    <div class="searchRow">
      <input id="search" type="search" placeholder="Search by name / email / phone" />
      <select id="filter-program" style="padding:10px;border-radius:8px;border:1px solid #ddd">
        <option value="">All programs</option>
        <option value="bronze">Bronze</option>
        <option value="silver">Silver</option>
        <option value="gold">Gold</option>
      </select>
    </div>

    <div class="grid-two">
      <div>
        <div class="card" style="margin-bottom:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3 style="margin:0">Approved Clients</h3>
            <div class="small" id="last-loaded">—</div>
          </div>
          <div style="margin-top:10px">
            <table>
              <thead>
                <tr><th>Name</th><th>Program</th><th>Joined</th><th>Status</th></tr>
              </thead>
              <tbody id="clientsTable">
                <tr><td colspan="4" class="no-data">Loading clients...</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3>Quick Actions</h3>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn" id="btn-new-resource">Upload resource</button>
            <button class="btn secondary" id="btn-view-resources">View resources</button>
          </div>
        </div>
      </div>

      <aside>
        <div class="card">
          <h3>Selected Client</h3>
          <div id="clientDetails" style="margin-top:10px">Pick a client from the list.</div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3>Resources</h3>
          <div class="resource-list" id="resourcesList"><div class="no-data">No resources</div></div>
          <div style="margin-top:10px">
            <small class="small">Mentors can upload files (links) and share with clients</small>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- simple modal -->
  <div id="modal" class="modal"><div class="box" id="modalBox"></div></div>

  <!-- Supabase + config -->
  <script type="module">
    // -------------- CONFIG PATTERN --------------
    // Put your keys into admin-config.js (recommended) OR
    // set SUPABASE_URL and SUPABASE_ANON_KEY below before deploying.
    // admin-config.js example:
    // export const SUPABASE_URL = 'https://xyz.supabase.co';
    // export const SUPABASE_ANON_KEY = 'eyJ...';
    //
    // NOTE: if you create admin-config.js, commit it only if you're OK with anon key being public.
    // (anon key is for client-side access only — never use service_role on client.)
    // -------------------------------------------

    // try import admin-config.js if present
    let SUPABASE_URL = null;
    let SUPABASE_ANON_KEY = null;

    async function tryLoadConfig() {
      try {
        // admin-config.js must export SUPABASE_URL and SUPABASE_ANON_KEY
        const cfg = await import('./admin-config.js').catch(()=>null);
        if (cfg && cfg.SUPABASE_URL && cfg.SUPABASE_ANON_KEY) {
          SUPABASE_URL = cfg.SUPABASE_URL;
          SUPABASE_ANON_KEY = cfg.SUPABASE_ANON_KEY;
        }
      } catch(e){ /* ignore */ }
    }
    await tryLoadConfig();

    // fallback: look for keys in URL hash (helpful for testing temporarily)
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      const hash = new URLSearchParams(location.hash.replace(/^#/,''));
      if (hash.get('supabase_url') && hash.get('supabase_key')) {
        SUPABASE_URL = hash.get('supabase_url');
        SUPABASE_ANON_KEY = hash.get('supabase_key');
        console.warn('Using keys from URL hash — remove after testing.');
      }
    }

    // final sanity
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      // show friendly message and stop
      document.getElementById('clientsTable').innerHTML = '<tr><td colspan="4" class="no-data">No Supabase config found. Create admin-config.js or add keys to URL hash for testing.</td></tr>';
      console.warn('No SUPABASE_URL / SUPABASE_ANON_KEY provided.');
      // still allow showing modal with instructions
    }

    // Import supabase client from CDN esm
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    let supabase = null;
    if (SUPABASE_URL && SUPABASE_ANON_KEY) supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---- utilities ----
    const $ = id => document.getElementById(id);
    function formatDate(d){ if(!d) return '—'; const dt=new Date(d); return dt.toLocaleDateString() }
    function showModal(html){ $('modal').classList.add('open'); $('modalBox').innerHTML = html + '<div style="margin-top:8px;text-align:right"><button class="btn" onclick="document.getElementById(\\'modal\\').classList.remove(\\'open\\')">Close</button></div>'; }
    window.addEventListener('click', e => { if(e.target.id === 'modal') $('modal').classList.remove('open'); });

    // ---- main app ----
    let allClients = [];
    let resources = [];

    async function loadClients() {
      if (!supabase) return;
      $('clientsTable').innerHTML = '<tr><td colspan="4" class="no-data">Loading...</td></tr>';
      try {
        // only approved clients: status = 'approved'
        const { data, error } = await supabase
          .from('clients')
          .select('*')
          .eq('status','approved')
          .order('created_at',{ ascending: false })
          .limit(500);

        if (error) throw error;
        allClients = data || [];
        renderClients();
        updateStats();
        $('last-loaded').textContent = 'Loaded: ' + new Date().toLocaleTimeString();
      } catch (err) {
        console.error(err);
        $('clientsTable').innerHTML = '<tr><td colspan="4" class="no-data">Error loading clients — check console</td></tr>';
      }
    }

    function renderClients() {
      const q = $('search').value.trim().toLowerCase();
      const program = $('filter-program').value;
      const rows = allClients.filter(c => {
        if (program && (c.program||'').toLowerCase() !== program) return false;
        if (!q) return true;
        return (c.name||'').toLowerCase().includes(q) || (c.email||'').toLowerCase().includes(q) || (c.phone||'').toLowerCase().includes(q);
      });

      if (!rows.length) {
        $('clientsTable').innerHTML = '<tr><td colspan="4" class="no-data">No clients found</td></tr>';
        return;
      }

      $('clientsTable').innerHTML = rows.map(c => `
        <tr data-id="${c.id}" style="cursor:pointer" onclick="selectClient('${c.id}')">
          <td>${escapeHtml(c.name || '—')}</td>
          <td>${escapeHtml(c.program || '—')}</td>
          <td>${formatDate(c.created_at)}</td>
          <td class="status-approved">Approved</td>
        </tr>
      `).join('');
    }

    function updateStats(){
      $('stat-count').textContent = allClients.length;
      const todayStart = new Date(); todayStart.setHours(0,0,0,0);
      const todayCount = allClients.filter(c => new Date(c.created_at) >= todayStart).length;
      $('stat-today').textContent = todayCount;
    }

    window.selectClient = function(id){
      const c = allClients.find(x => x.id === id);
      if (!c) return;
      $('clientDetails').innerHTML = `
        <div style="font-weight:700">${escapeHtml(c.name || '—')}</div>
        <div class="small">${escapeHtml(c.email || '—')} • ${escapeHtml(c.phone || '—')}</div>
        <div style="margin-top:8px"><strong>Program:</strong> ${escapeHtml(c.program || '—')}</div>
        <div style="margin-top:8px"><strong>Notes:</strong><div class="note" style="margin-top:6px">${escapeHtml(c.notes || 'No notes')}</div></div>
        <div style="margin-top:10px"><button class="btn" onclick="openSendTask('${escapeJs(id)}')">Assign Task</button></div>
      `;
    };

    function openSendTask(clientId){
      // simple task modal
      showModal(`
        <h3>Assign Task</h3>
        <div style="margin-top:8px">
          <textarea id="taskText" rows="4" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd" placeholder="Describe the task..."></textarea>
          <div style="margin-top:8px;text-align:right">
            <button class="btn" id="sendTaskBtn">Send</button>
          </div>
        </div>
      `);
      document.getElementById('sendTaskBtn').addEventListener('click', async ()=>{
        const txt = document.getElementById('taskText').value.trim();
        if(!txt){ alert('Write a task'); return; }
        await saveTask(clientId, txt);
        document.getElementById('modal').classList.remove('open');
        alert('Task saved (visible in DB).');
      });
    }

    async function saveTask(clientId, text){
      if (!supabase) { console.warn('no supabase'); return; }
      // lightweight tasks table: tasks(client_id, text, status, created_at)
      const { error } = await supabase.from('tasks').insert([{ client_id: clientId, text, status: 'pending', created_at: new Date().toISOString() }]);
      if (error) console.error('save task', error);
    }

    // resources
    async function loadResources(){
      if (!supabase) return;
      try {
        const { data, error } = await supabase.from('resources').select('*').order('created_at',{ascending:false}).limit(200);
        if (error) throw error;
        resources = data || [];
        renderResources();
      } catch(err){
        console.error(err);
        $('resourcesList').innerHTML = '<div class="no-data">Error loading resources</div>';
      }
    }
    function renderResources(){
      if (!resources.length) {
        $('resourcesList').innerHTML = '<div class="no-data">No resources</div>';
        return;
      }
      $('resourcesList').innerHTML = resources.map(r => `
        <div style="padding:8px;border-bottom:1px dashed #eee">
          <div style="font-weight:600">${escapeHtml(r.title || 'Untitled')}</div>
          <div class="small">${escapeHtml(r.description || '')}</div>
          <div style="margin-top:6px">
            ${r.url ? `<a href="${escapeHtmlAttr(r.url)}" target="_blank">Open</a>` : ''}
            <span class="small" style="float:right">${new Date(r.created_at).toLocaleString()}</span>
          </div>
        </div>
      `).join('');
    }

    // upload resource (simple link)
    async function uploadResource(){
      showModal(`
        <h3>Upload Resource (link)</h3>
        <div style="margin-top:8px">
          <input id="resTitle" placeholder="Title" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd" />
          <input id="resUrl" placeholder="https://..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-top:8px" />
          <textarea id="resDesc" rows="3" style="width:100%;padding:8px;border-radius:8px;border:1px solid #ddd;margin-top:8px" placeholder="Optional description"></textarea>
          <div style="margin-top:8px;text-align:right"><button class="btn" id="saveRes">Save</button></div>
        </div>
      `);
      document.getElementById('saveRes').addEventListener('click', async ()=>{
        const title = document.getElementById('resTitle').value.trim();
        const url = document.getElementById('resUrl').value.trim();
        const desc = document.getElementById('resDesc').value.trim();
        if(!title || !url){ alert('Title and URL required'); return; }
        if (!supabase) return alert('No supabase');
        const { error } = await supabase.from('resources').insert([{ title, url, description: desc, created_at: new Date().toISOString() }]);
        if (error) {
          console.error(error); alert('Error saving'); return;
        }
        document.getElementById('modal').classList.remove('open');
        await loadResources();
      });
    }

    // helpers
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function escapeHtmlAttr(s){ return (s||'').replace(/"/g,'&quot;'); }
    function escapeJs(s){ return (s||'').replace(/'/g,"\\'") }

    // wire UI
    $('btn-refresh').addEventListener('click', () => { loadClients(); loadResources(); });
    $('filter-program').addEventListener('change', renderClients);
    $('search').addEventListener('input', debounce(renderClients, 200));
    $('btn-new-resource').addEventListener('click', uploadResource);
    $('btn-view-resources').addEventListener('click', ()=> showModal('<h3>Resources</h3>' + document.getElementById('resourcesList').innerHTML));

    $('btn-login-info').addEventListener('click', ()=>{
      showModal(`<h3>Supabase config</h3>
        <div class="small">This page reads your keys from <code>admin-config.js</code> (recommended) or from the URL hash (temporary).</div>
        <div style="margin-top:8px"><strong>Example admin-config.js (place in same folder):</strong>
        <pre style="background:#f4f4f4;padding:8px;border-radius:6px">export const SUPABASE_URL = '${SUPABASE_URL||'https://your-project.supabase.co'}';\nexport const SUPABASE_ANON_KEY = 'eyJ...';</pre></div>`);
    });

    // debounce util
    function debounce(fn, wait=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait) } }

    // initial load
    if (supabase) {
      await Promise.all([loadClients(), loadResources()]);
    } else {
      // nothing configured yet
    }

  </script>
</body>
</html>
