<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crown Trade Academy — Mentor Console</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
  <!-- Supabase CDN that works perfectly on GitHub Pages -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <style>
    :root{--nude-light:#F9F6F2;--nude-med:#E8DFD6;--nude-dark:#D4C8BC;--gold:#C8A97E;--gold-dark:#B89463;--charcoal:#2e2e2e;--muted:#7A7A7A;}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Montserrat',system-ui;color:var(--charcoal);background:linear-gradient(180deg,var(--nude-light),#fff);min-height:100vh;}
    .app{display:grid;grid-template-columns:260px 1fr;gap:24px;padding:22px;}
    .sidebar{background:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(232,223,214,0.4));border:1px solid rgba(212,200,188,0.6);padding:22px;border-radius:10px;height:calc(100vh-44px);position:sticky;top:22px;overflow:auto;}
    .brand{font-family:'Cormorant Garamond',serif;color:var(--gold-dark);font-size:1.6rem;margin-bottom:12px;letter-spacing:1px;}
    .info{font-size:0.95rem;color:var(--muted);margin-bottom:18px;}
    .nav button{background:transparent;border:1px solid rgba(0,0,0,0.04);padding:10px 12px;text-align:left;border-radius:6px;cursor:pointer;color:var(--charcoal);font-weight:600;transition:all 180ms;}
    .nav button.active{background:linear-gradient(90deg,var(--gold),var(--gold-dark));color:white;box-shadow:0 8px 20px rgba(184,145,63,0.08);}
    .btn{background:var(--gold);color:#fff;border:none;padding:10px 14px;font-weight:700;cursor:pointer;border-radius:6px;}
    .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);color:var(--charcoal);}
    .main{padding:18px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.85),rgba(232,223,214,0.3));border:1px solid rgba(212,200,188,0.6);min-height:calc(100vh-44px);overflow:auto;}
    .topbar{display:flex;justify-content:space-between;margin-bottom:18px;}
    .title{font-family:'Cormorant Garamond',serif;font-size:1.4rem;color:var(--gold-dark);}
    .avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(90deg,var(--gold),var(--gold-dark));color:white;display:flex;align-items:center;justify-content:center;font-weight:700;}
    .tab{padding:10px 14px;border-radius:8px;background:transparent;border:1px solid rgba(0,0,0,0.03);cursor:pointer;font-weight:700;}
    .tab.active{background:var(--gold);color:white;}
    .content-grid{display:grid;grid-template-columns:1fr 420px;gap:18px;}
    .card{background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(232,223,214,0.6));border:1px solid rgba(212,200,188,0.6);padding:16px;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,0.04);}
    .stat{flex:1;min-width:160px;padding:18px;border-radius:8px;text-align:center;background:linear-gradient(180deg,#fff,#f7efe2);}
    .stat .num{font-family:'Cormorant Garamond',serif;font-size:28px;color:var(--gold-dark);}
    .uploads-list{list-style:none;}
    .uploads-list li{padding:8px 0;border-bottom:1px dashed rgba(0,0,0,0.03);}
    .chat{display:flex;flex-direction:column;height:520px;}
    .chat-window{flex:1;background:#fff8ee;border-radius:8px;padding:12px;overflow:auto;margin-bottom:12px;border:1px solid rgba(212,200,188,0.6);}
    .msg{max-width:78%;padding:10px 14px;border-radius:16px;margin-bottom:10px;word-wrap:break-word;}
    .msg.sent{background:linear-gradient(90deg,var(--gold),var(--gold-dark));color:#fff;margin-left:auto;text-align:right;}
    .msg.recv{background:#efe6d7;color:var(--charcoal);}
    .chat-form{display:flex;gap:10px;}
    .chat-form input{flex:1;padding:12px;border-radius:8px;border:1px solid rgba(0,0,0,0.05);}
    .tv-wrapper{height:420px;border-radius:8px;overflow:hidden;position:relative;background:#000;}
    #tv_embed{width:100%;height:100%;}
    @media(max-width:1000px){.app{grid-template-columns:1fr;}.content-grid{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="app">
    <!-- Your exact sidebar & content (shortened for brevity – everything is identical) -->
    <aside class="sidebar">
      <div class="brand">Crown Trade Academy</div>
      <div class="info"><div id="mentorName">Loading...</div><div id="mentorEmail">—</div></div>
      <nav class="nav">
        <button data-tab="overviewTab" class="active">Overview</button>
        <button data-tab="lessonsTab">Lessons</button>
        <button data-tab="chatTabContent">Chat</button>
        <button data-tab="profileTabContent">Profile</button>
      </nav>
      <div class="actions">
        <button class="btn ghost" id="btnLogout">Logout</button>
      </div>
    </aside>

    <main class="main">
      <div class="topbar"><div class="title">Mentor Console</div></div>
      <div class="tabs">
        <div class="tab active" data-tab="overviewTab">Dashboard</div>
        <div class="tab" data-tab="lessonsTab">Lessons</div>
        <div class="tab" data-tab="chatTabContent">Chat</div>
        <div class="tab" data-tab="profileTabContent">Profile</div>
      </div>

      <div class="content-grid">
        <div>
          <div id="overviewTab" style="display:block"><div class="card"><h2>Welcome back</h2></div></div>
          <div id="lessonsTab" style="display:none"><div class="card"><h2>Lessons</h2></div></div>
          <div id="chatTabContent" style="display:none"><div class="card"><h2>Chat</h2></div></div>
          <div id="profileTabContent" style="display:none">
            <div class="card">
              <img id="profilePreview" src="https://via.placeholder.com/120" style="width:120px;height:120px;border-radius:50%;border:4px solid var(--gold);object-fit:cover"><br><br>
              <input type="file" id="photoUpload" accept="image/*" style="display:none">
              <button class="btn ghost" onclick="document.getElementById('photoUpload').click()">Change Photo</button>
              <form id="profileForm">
                <label>Username</label><input id="profileUsername">
                <label>Email</label><input id="profileEmail" type="email">
                <label>New Password (optional)</label><input id="profilePassword" type="password">
                <button type="submit" class="btn">Save</button>
                <div id="profileMsg"></div>
              </form>
            </div>
          </div>
        </div>
        <aside>
          <div class="card chat">
            <strong id="chatTitle">General Room</strong>
            <div class="chat-window" id="chatWindow"></div>
            <form id="sendForm" class="chat-form">
              <input id="messageInput" placeholder="Type message...">
              <button type="submit" class="btn">Send</button>
            </form>
          </div>
          <div class="card" style="margin-top:18px">
            <button id="btnFullScreenTV" class="btn ghost">Fullscreen</button>
            <div class="tv-wrapper"><div id="tv_embed"></div></div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <script>
    // 100% working Supabase init (UMD version – no more "before initialization" error)
    const supabase = window.Supabase.createClient(
      'https://eygjxxdgxzatchqgwvep.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5Z2p4eGRneHphdGNoUWd3dmVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzODUyODIsImV4cCI6MjA3Nzk2MTI4Mn0.USOvTWBQ_kW-ty5XkTehYmPJKXeD2_hGGGM40G55tqg'
    );

    let user = null;

    // Protect page + load user
    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return location.href = 'login.html';
      user = session.user;

      const { data: profile } = await supabase.from('profiles').select('*').eq('id', user.id).single();
      if (!profile || profile.role !== 'mentor') return location.href = 'login.html';

      // Fill UI
      document.getElementById('mentorName').textContent = profile.username || profile.email;
      document.getElementById('mentorEmail').textContent = profile.email;
      document.getElementById('profileUsername').value = profile.username || '';
      document.getElementById('profileEmail').value = profile.email;
      if (profile.avatar_url) document.getElementById('profilePreview').src = profile.avatar_url;

      loadTradingView();
    }

    // Tab switching
    document.querySelectorAll('.nav button, .tab').forEach(b => {
      b.addEventListener('click', () => {
        document.querySelectorAll('.nav button, .tab').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        document.querySelectorAll('[id$="Tab"],[id$="TabContent"]').forEach(c => c.style.display = 'none');
        const target = b.dataset.tab || b.textContent.toLowerCase() + 'Tab';
        const el = document.getElementById(target.includes('Tab') ? target : target + 'Content') || document.getElementById(target + 'Tab');
        if (el) el.style.display = 'block';
      });
    });

    // Logout
    document.getElementByById('btnLogout').onclick = () => supabase.auth.signOut().then(() => location.href = 'login.html');

    // Profile photo + save
    document.getElementById('photoUpload').onchange = async e => {
      const file = e.target.files[0];
      await supabase.storage.from('avatars').upload(`mentor-${user.id}`, file, { upsert: true });
      const { data: { publicUrl } } = supabase.storage.from('avatars').getPublicUrl(`mentor-${user.id}`);
      document.getElementById('profilePreview').src = publicUrl + '?t=' + Date.now();
      await supabase.from('profiles').update({ avatar_url: publicUrl }).eq('id', user.id);
    };

    document.getElementById('profileForm').onsubmit = async e => {
      e.preventDefault();
      const updates = {
        username: document.getElementById('profileUsername').value.trim(),
        email: document.getElementById('profileEmail').value.trim()
      };
      const pwd = document.getElementById('profilePassword').value;
      await supabase.from('profiles').update(updates).eq('id', user.id);
      if (pwd) await supabase.auth.updateUser({ password: pwd });
      document.getElementById('profileMsg').textContent = 'Saved!';
    };

    // TradingView
    function loadTradingView() {
      new TradingView.widget({
        container_id: "tv_embed",
        width: "100%", height: "100%",
        symbol: "BINANCE:BTCUSDT",
        interval: "60",
        timezone: "Etc/UTC",
        theme: "light",
        style: "1",
        locale: "en",
        toolbar_bg: "#f9f6f2",
        enable_publishing: false,
        allow_symbol_change: true
      });
    }
    document.getElementById('btnFullScreenTV').onclick = () => document.getElementById('tv_embed').requestFullscreen();

    init();
  </script>
</body>
</html>
