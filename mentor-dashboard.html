<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mentor Dashboard</title>
  <style>
    /* Your original CSS here, unchanged */
    :root {
      --gold-dark: #b8860b;
      --bg-light: #f9f6f2;
      --text-dark: #333;
    }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg-light);
      color: var(--text-dark);
      margin: 0; padding: 0;
    }
    header, main, aside {
      padding: 10px;
    }
    .tabs {
      display: flex;
      border-bottom: 2px solid var(--gold-dark);
      margin-bottom: 15px;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      font-weight: 600;
      border-bottom: 3px solid transparent;
    }
    .tab.active {
      border-color: var(--gold-dark);
      color: var(--gold-dark);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    button.btn {
      cursor: pointer;
      background: transparent;
      border: 1px solid var(--gold-dark);
      color: var(--gold-dark);
      padding: 6px 12px;
      border-radius: 4px;
      font-weight: 600;
      transition: background 0.2s, color 0.2s;
    }
    button.btn:hover {
      background: var(--gold-dark);
      color: #fff;
    }
    .btn.ghost {
      background: none;
      border: none;
      color: var(--gold-dark);
      font-weight: 700;
      cursor: pointer;
    }
    .card {
      background: #fff;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgb(0 0 0 / 0.1);
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin: 10px 0 5px 0;
      font-weight: 600;
    }
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="file"] {
      width: 100%;
      padding: 8px 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    #profilePicPreview {
      margin-top: 10px;
      max-width: 150px;
      border-radius: 4px;
      display: block;
    }
  </style>
</head>
<body>

<header>
  <h1>Mentor Dashboard</h1>
</header>

<main>
  <div class="tabs" id="tabsContainer">
    <div class="tab active" data-tab="chat">Chat</div>
    <div class="tab" data-tab="tradingview">TradingView</div>
    <div class="tab" data-tab="profile">Profile</div>
  </div>

  <div id="chat" class="tab-content active">
    <div id="chatWindow" class="card" style="height:300px; overflow-y:auto; background:#fff; border:1px solid #ddd; padding:10px;">
      <!-- Chat messages appear here -->
    </div>
    <button id="btnClearChat" class="btn" style="margin-top:10px;">Clear Chat View</button>
  </div>

  <div id="tradingview" class="tab-content">
    <div class="card" style="margin-top:18px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div style="font-weight:800; color:var(--gold-dark)">Trading Chart</div>
        <div>
          <button id="btnFullScreenTV" class="btn ghost">Fullscreen</button>
        </div>
      </div>
      <div class="tv-wrapper" id="tvContainer">
        <div id="tv_embed"></div>
      </div>
    </div>
  </div>

  <div id="profile" class="tab-content">
    <div class="card">
      <h2>Update Profile</h2>
      <form id="profileForm">
        <label for="username">Username</label>
        <input type="text" id="username" name="username" required>

        <label for="email">Email</label>
        <input type="email" id="email" name="email" required>

        <label for="password">New Password (leave blank to keep current)</label>
        <input type="password" id="password" name="password" placeholder="••••••">

        <label for="profilePic">Profile Picture</label>
        <input type="file" id="profilePic" accept="image/*">
        <img id="profilePicPreview" src="" alt="Profile Preview" style="display:none;">

        <button type="submit" class="btn" style="margin-top:15px;">Save Changes</button>
      </form>
      <div id="profileStatus" style="margin-top:10px; color: green;"></div>
    </div>
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Replace these with your real keys from the ones you gave
  const SUPABASE_URL = "https://eygjxxdgxzatchqgwvep.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5Z2p4eGRneHphdGNocWd3dmVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzODUyODIsImV4cCI6MjA3Nzk2MTI4Mn0.USOvTWBQ_kW-ty5XkTehYmPJKXeD2_hGGGM40G55tqg";

  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Tab switching logic
  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const target = tab.getAttribute('data-tab');

      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');

      tabContents.forEach(tc => {
        if(tc.id === target){
          tc.classList.add('active');
        } else {
          tc.classList.remove('active');
        }
      });
    });
  });

  // Helper selector function
  function $(selector){ return document.querySelector(selector); }

  // Clear Chat button logic
  $('#btnClearChat').addEventListener('click', async () => {
    if(!confirm('Clear local chat view? This will not delete messages from database.')) return;
    $('#chatWindow').innerHTML = '';
  });

  // TradingView embed + fullscreen control
  function loadTradingView(){
    const container = document.getElementById('tv_embed');
    container.innerHTML = '';
    const scr = document.createElement('script');
    scr.src = 'https://s3.tradingview.com/tv.js';
    scr.onload = () => {
      try {
        new TradingView.widget({
          "width": "100%",
          "height": 400,
          "symbol": "FOREXCOM:EURUSD",
          "interval": "60",
          "timezone": "Etc/UTC",
          "theme": "Light",
          "style": "1",
          "locale": "en",
          "toolbar_bg": "#f9f6f2",
          "enable_publishing": false,
          "container_id": "tv_embed"
        });
      } catch(err) {
        console.error('TradingView init error', err);
      }
    };
    document.getElementById('tvContainer').appendChild(scr);
  }

  $('#btnFullScreenTV').addEventListener('click', () => {
    const elem = document.getElementById('tvContainer');
    if(!document.fullscreenElement){
      elem.requestFullscreen?.();
    } else {
      document.exitFullscreen?.();
    }
  });

  // Load TradingView on page load
  loadTradingView();

  // Profile update logic
  const profileForm = $('#profileForm');
  const profilePicInput = $('#profilePic');
  const profilePicPreview = $('#profilePicPreview');
  const profileStatus = $('#profileStatus');

  let profilePicFile = null;

  // Preview profile pic on select
  profilePicInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if(file && file.type.startsWith('image/')){
      profilePicFile = file;
      const reader = new FileReader();
      reader.onload = () => {
        profilePicPreview.src = reader.result;
        profilePicPreview.style.display = 'block';
      }
      reader.readAsDataURL(file);
    } else {
      profilePicPreview.src = '';
      profilePicPreview.style.display = 'none';
      profilePicFile = null;
    }
  });

  async function loadUserProfile() {
    const user = supabase.auth.getUser();
    const { data, error } = await supabase.auth.getUser();

    if(error){
      console.error('Error getting user:', error);
      return;
    }
    if(!data || !data.user) return;

    const userData = data.user;

    $('#username').value = userData.user_metadata?.username || '';
    $('#email').value = userData.email || '';

    // Load profile pic from Supabase storage if exists
    if(userData.user_metadata?.avatar_url){
      const { data: urlData, error: urlError } = await supabase.storage
        .from('avatars')
        .getPublicUrl(userData.user_metadata.avatar_url);

      if(urlError){
        console.error('Error fetching profile pic url:', urlError);
      } else {
        profilePicPreview.src = urlData.publicUrl;
        profilePicPreview.style.display = 'block';
      }
    }
  }

  // On page load get profile
  loadUserProfile();

  profileForm.addEventListener('submit', async e => {
    e.preventDefault();

    profileStatus.textContent = '';
    const username = $('#username').value.trim();
    const email = $('#email').value.trim();
    const password = $('#password').value;

    if(!username || !email){
      alert('Username and Email are required');
      return;
    }

    const user = await supabase.auth.getUser();
    if(!user.data.user){
      alert('No authenticated user found.');
      return;
    }

    const userId = user.data.user.id;

    // Upload profile picture if changed
    let avatar_url = null;
    if(profilePicFile){
      const fileExt = profilePicFile.name.split('.').pop();
      const fileName = `${userId}.${fileExt}`;
      const filePath = `avatars/${fileName}`;

      const { error: uploadError } = await supabase.storage
        .from('avatars')
        .upload(filePath, profilePicFile, { upsert: true });

      if(uploadError){
        alert('Failed to upload profile picture.');
        return;
      }
      avatar_url = filePath;
    }

    // Update user metadata
    const updates = {
      id: userId,
      email,
      password: password || undefined, // only update if provided
      user_metadata: {
        username,
        avatar_url: avatar_url || undefined,
      }
    };

    try {
      // Update email/password requires special methods
      // First update email if changed
      if(email !== user.data.user.email){
        const { error: emailError } = await supabase.auth.updateUser({
          email,
        });
        if(emailError){
          alert('Failed to update email: ' + emailError.message);
          return;
        }
      }

      // Update password if provided
      if(password){
        const { error: passError } = await supabase.auth.updateUser({
          password,
        });
        if(passError){
          alert('Failed to update password: ' + passError.message);
          return;
        }
      }

      // Update user metadata (username, avatar)
      const { error: metaError } = await supabase.auth.updateUser({
        data: {
          username,
          avatar_url
        }
      });

      if(metaError){
        alert('Failed to update profile info: ' + metaError.message);
        return;
      }

      profileStatus.style.color = 'green';
      profileStatus.textContent = 'Profile updated successfully.';
      if(avatar_url){
        const { data: urlData, error: urlError } = await supabase.storage
          .from('avatars')
          .getPublicUrl(avatar_url);
        if(!urlError){
          profilePicPreview.src = urlData.publicUrl;
          profilePicPreview.style.display = 'block';
        }
      }
    } catch(err){
      console.error(err);
      alert('Unexpected error while updating profile.');
    }
  });

</script>

</body>
</html>
