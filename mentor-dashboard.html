<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mentor Dashboard</title>
  <style>
    :root {
      --gold-dark: #b58900;
      --bg-color: #fff;
      --text-color: #333;
      --btn-bg: transparent;
      --btn-border: 1px solid var(--gold-dark);
      --btn-hover-bg: var(--gold-dark);
      --btn-hover-color: #fff;
    }
    body {
      font-family: Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin: 0; padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    main {
      flex: 1;
      padding: 16px;
      max-width: 1100px;
      margin: auto;
    }
    .tabs {
      display: flex;
      border-bottom: 2px solid var(--gold-dark);
      margin-bottom: 16px;
    }
    .tab {
      padding: 12px 20px;
      cursor: pointer;
      user-select: none;
      font-weight: 700;
      color: var(--gold-dark);
      border-bottom: 3px solid transparent;
      transition: border-color 0.3s ease;
    }
    .tab.active {
      border-bottom: 3px solid var(--gold-dark);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .btn {
      padding: 8px 14px;
      cursor: pointer;
      border: var(--btn-border);
      background: var(--btn-bg);
      color: var(--gold-dark);
      font-weight: 600;
      border-radius: 4px;
      transition: background 0.3s ease, color 0.3s ease;
      user-select: none;
    }
    .btn:hover {
      background: var(--btn-hover-bg);
      color: var(--btn-hover-color);
    }
    .btn.ghost {
      border-color: transparent;
      color: var(--gold-dark);
      font-weight: 700;
    }
    .btn.ghost:hover {
      background: var(--btn-hover-bg);
      color: var(--btn-hover-color);
    }
    input, label {
      display: block;
      margin: 8px 0 4px 0;
      font-weight: 600;
    }
    input[type="text"], input[type="email"], input[type="password"] {
      width: 100%;
      padding: 6px 8px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .profile-pic-preview {
      margin-top: 12px;
      max-width: 150px;
      max-height: 150px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--gold-dark);
    }
    .form-group {
      margin-bottom: 16px;
    }
    /* TradingView container fix */
    .tv-wrapper {
      width: 100%;
      height: 400px;
      position: relative;
    }
    /* Chat window */
    #chatWindow {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 8px;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>

<main>
  <div class="tabs" role="tablist" aria-label="Mentor Dashboard Tabs">
    <div class="tab active" data-tab="dashboard" role="tab" tabindex="0" aria-selected="true">Dashboard</div>
    <div class="tab" data-tab="chat" role="tab" tabindex="-1">Chat</div>
    <div class="tab" data-tab="tradingview" role="tab" tabindex="-1">TradingView</div>
    <div class="tab" data-tab="profile" role="tab" tabindex="-1">Profile</div>
  </div>

  <section id="dashboard" class="tab-content active" role="tabpanel">
    <h2>Welcome Mentor</h2>
    <p>Here you can manage your activities.</p>
  </section>

  <section id="chat" class="tab-content" role="tabpanel" aria-hidden="true">
    <h2>Chat Window</h2>
    <div id="chatWindow"></div>
    <button id="btnClearChat" class="btn">Clear Chat</button>
  </section>

  <section id="tradingview" class="tab-content" role="tabpanel" aria-hidden="true">
    <div class="card" style="margin-top:18px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
        <div style="font-weight:800; color:var(--gold-dark)">Trading Chart</div>
        <div>
          <button id="btnFullScreenTV" class="btn ghost">Fullscreen</button>
        </div>
      </div>
      <div class="tv-wrapper" id="tvContainer">
        <div id="tv_embed"></div>
      </div>
    </div>
  </section>

  <section id="profile" class="tab-content" role="tabpanel" aria-hidden="true">
    <h2>Manage Your Profile</h2>
    <form id="profileForm" style="max-width:400px;">
      <div class="form-group">
        <label for="usernameInput">Username</label>
        <input type="text" id="usernameInput" name="username" required />
      </div>
      <div class="form-group">
        <label for="emailInput">Email</label>
        <input type="email" id="emailInput" name="email" required />
      </div>
      <div class="form-group">
        <label for="passwordInput">New Password (leave blank to keep current)</label>
        <input type="password" id="passwordInput" name="password" autocomplete="new-password" />
      </div>
      <div class="form-group">
        <label for="profilePicInput">Profile Picture</label>
        <input type="file" id="profilePicInput" accept="image/*" />
        <img id="profilePicPreview" class="profile-pic-preview" alt="Profile Picture Preview" />
      </div>
      <button type="submit" class="btn">Save Changes</button>
      <div id="profileMessage" style="margin-top:12px; font-weight:600;"></div>
    </form>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Your Supabase credentials
  const SUPABASE_URL = 'https://eygjxxdgxzatchqgwvep.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5Z2p4eGRneHphdGNocWd3dmVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzODUyODIsImV4cCI6MjA3Nzk2MTI4Mn0.USOvTWBQ_kW-ty5XkTehYmPJKXeD2_hGGGM40G55tqg';

  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Helper shortcut
  const $ = (sel) => document.querySelector(sel);

  // Tab switching logic
  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const target = tab.dataset.tab;
      tabs.forEach(t => {
        t.classList.toggle('active', t === tab);
        t.setAttribute('aria-selected', t === tab ? 'true' : 'false');
        t.setAttribute('tabindex', t === tab ? '0' : '-1');
      });
      tabContents.forEach(tc => {
        tc.classList.toggle('active', tc.id === target);
        tc.setAttribute('aria-hidden', tc.id === target ? 'false' : 'true');
      });

      // Special hook: Load TradingView only when tab opens
      if(target === 'tradingview'){
        loadTradingView();
      }
      if(target === 'profile'){
        loadProfile();
      }
    });
  });

  // Clear chat button
  $('#btnClearChat').addEventListener('click', async () => {
    if(!confirm('Clear local chat view? This will not delete messages from database.')) return;
    $('#chatWindow').innerHTML = '';
  });

  // TradingView widget loader
  function loadTradingView(){
    const container = document.getElementById('tv_embed');
    container.innerHTML = '';
    const scr = document.createElement('script');
    scr.src = 'https://s3.tradingview.com/tv.js';
    scr.onload = () => {
      try {
        new TradingView.widget({
          width: "100%",
          height: 400,
          symbol: "FOREXCOM:EURUSD",
          interval: "60",
          timezone: "Etc/UTC",
          theme: "Light",
          style: "1",
          locale: "en",
          toolbar_bg: "#f9f6f2",
          enable_publishing: false,
          container_id: "tv_embed"
        });
      } catch(err){
        console.error('TradingView init error', err);
      }
    };
    document.getElementById('tvContainer').appendChild(scr);
  }

  // TradingView fullscreen toggle
  $('#btnFullScreenTV').addEventListener('click', () => {
    const elem = document.getElementById('tvContainer');
    if(!document.fullscreenElement){
      elem.requestFullscreen?.();
    } else {
      document.exitFullscreen?.();
    }
  });

  // Load mentor profile data into form
  async function loadProfile(){
    const user = supabase.auth.getUser ? (await supabase.auth.getUser()).data.user : null;
    if(!user) {
      showProfileMessage('You are not logged in.', true);
      return;
    }

    // Get profile info from 'profiles' table (assumed schema: id=uuid, username=text, avatar_url=text)
    const { data, error } = await supabase
      .from('profiles')
      .select('username, avatar_url')
      .eq('id', user.id)
      .single();

    if(error){
      console.error('Profile fetch error:', error);
      showProfileMessage('Failed to load profile info.', true);
      return;
    }

    $('#usernameInput').value = data.username || '';
    $('#emailInput').value = user.email || '';
    $('#profilePicPreview').src = data.avatar_url ? getPublicURL(data.avatar_url) : '';
  }

  // Helper: Show messages below profile form
  function showProfileMessage(msg, isError=false){
    const el = $('#profileMessage');
    el.textContent = msg;
    el.style.color = isError ? 'red' : 'green';
  }

  // Convert stored path to public URL for images in Supabase Storage
  function getPublicURL(path){
    return supabase.storage.from('avatars').getPublicUrl(path).data.publicUrl;
  }

  // Handle profile pic preview on file select
  $('#profilePicInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const url = URL.createObjectURL(file);
    $('#profilePicPreview').src = url;
  });

  // Profile form submit: update username, email, password, profile pic
  $('#profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    showProfileMessage('Saving...');

    const user = supabase.auth.getUser ? (await supabase.auth.getUser()).data.user : null;
    if(!user){
      showProfileMessage('You are not logged in.', true);
      return;
    }

    const username = $('#usernameInput').value.trim();
    const email = $('#emailInput').value.trim();
    const newPassword = $('#passwordInput').value;
    const profilePicFile = $('#profilePicInput').files[0];

    // Validate username and email
    if(!username || !email){
      showProfileMessage('Username and email cannot be empty.', true);
      return;
    }

    // Update email and password using Supabase Auth
    if(email !== user.email){
      const { error: emailError } = await supabase.auth.updateUser({ email });
      if(emailError){
        showProfileMessage('Email update failed: ' + emailError.message, true);
        return;
      }
    }

    if(newPassword){
      if(newPassword.length < 6){
        showProfileMessage('Password must be at least 6 characters.', true);
        return;
      }
      const { error: passError } = await supabase.auth.updateUser({ password: newPassword });
      if(passError){
        showProfileMessage('Password update failed: ' + passError.message, true);
        return;
      }
    }

    // Upload profile pic if changed
    let avatar_url = null;
    if(profilePicFile){
      const fileExt = profilePicFile.name.split('.').pop();
      const filePath = `avatars/${user.id}.${fileExt}`;

      // Remove old file (optional): Not implemented here to avoid complexity

      const { error: uploadError } = await supabase.storage
        .from('avatars')
        .upload(filePath, profilePicFile, { upsert: true });

      if(uploadError){
        showProfileMessage('Profile picture upload failed: ' + uploadError.message, true);
        return;
      }

      avatar_url = filePath;
    }

    // Update username and avatar_url in profiles table
    const updates = {
      id: user.id,
      username,
      updated_at: new Date().toISOString(),
    };
    if(avatar_url) updates.avatar_url = avatar_url;

    const { error: profileError } = await supabase
      .from('profiles')
      .upsert(updates, { returning: 'minimal' });

    if(profileError){
      showProfileMessage('Profile update failed: ' + profileError.message, true);
      return;
    }

    showProfileMessage('Profile updated successfully!');

    // Clear password field
    $('#passwordInput').value = '';

    // Reload profile pic public URL if updated
    if(avatar_url){
      $('#profilePicPreview').src = getPublicURL(avatar_url);
    }
  });

  // Boot function (called on page load)
  async function boot(){
    // For demo/testing: simulate logged-in user
    // In production, you must handle actual login and auth persistence
    const session = supabase.auth.getSession ? (await supabase.auth.getSession()).data.session : null;
    if(!session){
      showProfileMessage('Please login first.');
      // Optionally redirect to login or show a login modal
    }

    // Load initial tab content if needed
  }

  // Start app
  boot();
</script>

</body>
</html>
