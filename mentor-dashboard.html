<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Crown Trade Academy — Mentor Console (Version A, Fully Working 2025)</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --nude-light:#F9F6F2;
      --nude-med:#E8DFD6;
      --nude-dark:#D4C8BC;
      --gold:#C8A97E;
      --gold-dark:#B89463;
      --charcoal:#2e2e2e;
      --muted:#7A7A7A;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: 'Montserrat', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue";
      background: linear-gradient(180deg, var(--nude-light), #fff);
      color:var(--charcoal);
      -webkit-font-smoothing:antialiased;
      min-height:100vh;
    }
    .app { display: grid; grid-template-columns: 260px 1fr; gap:24px; padding:22px; }
    .sidebar {
      background: linear-gradient(180deg, rgba(255,255,255,0.6), rgba(232,223,214,0.4));
      border:1px solid rgba(212,200,188,0.6);
      padding:22px; border-radius:10px; height:calc(100vh - 44px);
      position:sticky; top:22px; overflow:auto;
    }
    .brand { font-family:'Cormorant Garamond', serif; color:var(--gold-dark); font-size:1.6rem; margin-bottom:12px; letter-spacing:1px; }
    .sidebar .info { font-size:0.95rem; color:var(--muted); margin-bottom:18px; }
    .nav { display:flex; flex-direction:column; gap:8px; margin-bottom:18px; }
    .nav button{
      background:transparent; border:1px solid rgba(0,0,0,0.04); padding:10px 12px;
      text-align:left; border-radius:6px; cursor:pointer; color:var(--charcoal);
      font-weight:600; transition: all 180ms;
    }
    .nav button.active{ background:linear-gradient(90deg,var(--gold),var(--gold-dark)); color:white; box-shadow:0 8px 20px rgba(184,145,63,0.08); }
    .small { font-size:13px; color:var(--muted); margin-top:12px; }
    .actions { margin-top:18px; display:flex; gap:10px; flex-wrap:wrap; }
    .btn { background:var(--gold); color:#fff; border:none; padding:10px 14px; font-weight:700; cursor:pointer; border-radius:6px; }
    .btn.ghost{ background:transparent; border:1px solid rgba(0,0,0,0.06); color:var(--charcoal); }
    .main {
      padding:18px; border-radius:10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(232,223,214,0.3));
      border:1px solid rgba(212,200,188,0.6); min-height:calc(100vh - 44px); overflow:auto;
    }
    .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; }
    .topbar .title { font-family:'Cormorant Garamond', serif; font-size:1.4rem; color:var(--gold-dark); }
    .profile-pill { display:flex; gap:12px; align-items:center; color:var(--charcoal); }
    .avatar { width:44px; height:44px; border-radius:50%; background:linear-gradient(90deg,var(--gold),var(--gold-dark)); color:white; display:flex; align-items:center; justify-content:center; font-weight:700; }
    .tabs { display:flex; gap:10px; margin-bottom:18px; flex-wrap:wrap; }
    .tab { padding:10px 14px; border-radius:8px; background:transparent; border:1px solid rgba(0,0,0,0.03); cursor:pointer; font-weight:700; color:var(--charcoal); }
    .tab.active { background:var(--gold); color:white; box-shadow:0 8px 20px rgba(184,145,63,0.08); }
    .content-grid { display:grid; grid-template-columns: 1fr 420px; gap:18px; align-items:start; }
    .card { background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(232,223,214,0.6)); border:1px solid rgba(212,200,188,0.6); padding:16px; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.04); }
    .cards { display:flex; gap:12px; margin-bottom:14px; flex-wrap:wrap; }
    .stat { flex:1; min-width:160px; padding:18px; border-radius:8px; text-align:center; background:linear-gradient(180deg,#fff,#f7efe2); font-weight:700; }
    .stat .num { font-family:'Cormorant Garamond', serif; font-size:28px; color:var(--gold-dark); }
    .stat .label { color:var(--muted); font-size:12px; margin-top:6px; text-transform:uppercase; letter-spacing:1px; }
    .uploads-list { list-style:none; padding-left:0; margin:0; }
    .uploads-list li { padding:8px 0; border-bottom:1px dashed rgba(0,0,0,0.03); color:var(--charcoal); }
    .chat { display:flex; flex-direction:column; height:520px; }
    .conversations { display:flex; flex-direction:column; gap:8px; max-height:160px; overflow:auto; margin-bottom:12px; }
    .conversation { padding:8px 10px; border-radius:8px; background:rgba(255,255,255,0.7); cursor:pointer; border:1px solid rgba(0,0,0,0.03); }
    .conversation.active { background:linear-gradient(90deg,var(--gold),var(--gold-dark)); color:white; }
    .chat-window { flex:1; background:#fff8ee; border-radius:8px; padding:12px; overflow:auto; margin-bottom:12px; border:1px solid rgba(212,200,188,0.6); }
    .msg { display:block; max-width:78%; padding:10px 14px; border-radius:16px; margin-bottom:10px; clear:both; word-wrap:break-word; }
    .msg.sent { background:linear-gradient(90deg,var(--gold),var(--gold-dark)); color:#fff; margin-left:auto; text-align:right; }
    .msg.recv { background:#efe6d7; color:var(--charcoal); margin-right:auto; text-align:left; }
    .chat-form { display:flex; gap:10px; }
    .chat-form input { flex:1; padding:12px; border-radius:8px; border:1px solid rgba(0,0,0,0.05); }
    .chat-form button { padding:12px 18px; border-radius:8px; border:none; background:var(--gold); color:#fff; font-weight:700; cursor:pointer; }
    .tv-wrapper { height:420px; border-radius:8px; overflow:hidden; position:relative; }
    .tv-full-btn { position:absolute; right:12px; top:12px; z-index:20; padding:8px 10px; background:rgba(255,255,255,0.9); border-radius:6px; border:1px solid rgba(0,0,0,0.06); cursor:pointer; font-weight:700; }
    .profile-form label { display:block; font-weight:700; margin-bottom:6px; color:var(--muted); }
    .profile-form input, .profile-form select { width:100%; padding:10px; border-radius:8px; border:1px solid rgba(0,0,0,0.04); margin-bottom:12px; }
    @media(max-width:1000px){
      .app{ grid-template-columns: 1fr; padding:12px; }
      .sidebar{ position:relative; height:auto; width:100%; display:flex; gap:12px; align-items:center; justify-content:space-between; }
      .content-grid{ grid-template-columns: 1fr; }
      .chat{ height:420px; }
      .tv-wrapper{ height:300px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">Crown Trade Academy</div>
      <div class="info">
        <div id="mentorName">Loading...</div>
        <div style="font-size:13px; color:var(--muted);" id="mentorEmail">—</div>
      </div>
      <nav class="nav">
        <button data-tab="overview" class="active">Overview</button>
        <button data-tab="lessons">Lessons</button>
        <button data-tab="meetings">Meetings</button>
        <button data-tab="chatTab">Chat</button>
        <button data-tab="profileTab">Profile</button>
      </nav>
      <div class="small">Quick actions</div>
      <div class="actions">
        <button class="btn" id="btnRefresh">Refresh</button>
        <button class="btn ghost" id="btnLogout">Logout</button>
      </div>
      <div style="margin-top:16px" class="small">Help & Support</div>
      <div style="margin-top:6px; font-size:13px; color:var(--muted)">contact@crowntrade.academy</div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="topbar">
        <div class="title">Mentor Console — Luxury Edition</div>
        <div class="profile-pill">
          <div class="avatar" id="avatarInitials">M</div>
          <div style="text-align:right">
            <div id="topName" style="font-weight:700">Mentor</div>
            <div style="font-size:12px;color:var(--muted)" id="topEmail">—</div>
          </div>
        </div>
      </div>

      <div class="tabs" id="mainTabs">
        <div class="tab active" data-show="overviewTab">Dashboard</div>
        <div class="tab" data-show="lessonsTab">Lessons</div>
        <div class="tab" data-show="meetingsTab">Meetings</div>
        <div class="tab" data-show="chatTabContent">Chat</div>
        <div class="tab" data-show="profileTabContent">Profile</div>
      </div>

      <div class="content-grid">
        <div>
          <!-- Overview -->
          <div id="overviewTab" class="tab-content" style="display:block">
            <h2>Overview</h2>
            <div class="cards card">
              <div class="stat"><div class="num" id="statClients">0</div><div class="label">Active Clients</div></div>
              <div class="stat"><div class="num" id="statLessons">0</div><div class="label">Upcoming Lessons</div></div>
              <div class="stat"><div class="num" id="statEarnings">KES 0</div><div class="label">Earnings</div></div>
            </div>
            <div class="card">
              <h3 style="font-family:'Cormorant Garamond', serif; color:var(--gold-dark); margin-bottom:12px">Recent Uploads</h3>
              <ul class="uploads-list" id="uploadsList"><li>Loading...</li></ul>
            </div>
          </div>

          <!-- Lessons -->
          <div id="lessonsTab" class="tab-content" style="display:none">
            <h2>Lessons & Uploads</h2>
            <div class="card">
              <form id="uploadForm">
                <label for="uploadTitle">Title</label>
                <input id="uploadTitle" required placeholder="e.g., Candlestick Mastery" />
                <label for="uploadFile">File URL</label>
                <input id="uploadFile" placeholder="https://..." required />
                <div style="display:flex; gap:10px; margin-top:8px">
                  <button type="submit" class="btn">Upload Lesson</button>
                  <button type="button" id="btnSample" class="btn ghost">Sample</button>
                </div>
              </form>
              <div id="uploadMsg" style="margin-top:10px; color:var(--gold-dark)"></div>
            </div>
          </div>

          <!-- Meetings -->
          <div id="meetingsTab" class="tab-content" style="display:none">
            <h2>Meetings</h2>
            <div class="card">
              <input id="meetingTitle" placeholder="Meeting title" />
              <input id="meetingDate" type="datetime-local" style="margin-top:8px" />
              <input id="meetingLink" placeholder="Zoom/Meet link (optional)" style="margin-top:8px" />
              <div style="margin-top:10px; display:flex; gap:8px;">
                <button id="btnSchedule" class="btn">Schedule</button>
              </div>
              <div id="meetingsList" style="margin-top:12px; color:var(--muted)"></div>
            </div>
          </div>

          <!-- Chat Conversations -->
          <div id="chatTabContent" class="tab-content" style="display:none">
            <h2>Chat — Conversations</h2>
            <div class="card">
              <div class="conversations" id="conversationList">
                <div class="conversation active" data-room="general">General Room</div>
              </div>
            </div>
          </div>

          <!-- Profile -->
          <div id="profileTabContent" class="tab-content" style="display:none">
            <h2>Profile Settings</h2>
            <div class="card">
              <div style="text-align:center;margin-bottom:20px">
                <img id="profilePreview" src="https://via.placeholder.com/120" style="width:120px;height:120px;border-radius:50%;border:4px solid var(--gold);object-fit:cover" alt="Profile" />
                <br><br>
                <input type="file" id="photoUpload" accept="image/*" style="display:none" />
                <button class="btn ghost" onclick="document.getElementById('photoUpload').click()">Change Photo</button>
              </div>
              <form id="profileForm" class="profile-form">
                <label>Username</label>
                <input id="profileUsername" required />
                <label>Email</label>
                <input id="profileEmail" type="email" required />
                <label>New Password (leave blank to keep)</label>
                <input id="profilePassword" type="password" />
                <button type="submit" class="btn" style="margin-top:15px">Save Changes</button>
                <div id="profileMsg" style="margin-top:10px;color:var(--gold-dark)"></div>
              </form>
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <aside>
          <div class="card chat" id="chatPane">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <div><strong id="chatTitle">General Room</strong></div>
              <button id="btnClearChat" class="btn ghost">Clear</button>
            </div>
            <div class="chat-window" id="chatWindow"></div>
            <form id="sendForm" class="chat-form">
              <input id="messageInput" placeholder="Type a message..." autocomplete="off" />
              <button type="submit" class="btn">Send</button>
            </form>
          </div>

          <div class="card" style="margin-top:18px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <div style="font-weight:800; color:var(--gold-dark)">Live Chart</div>
              <button id="btnFullScreenTV" class="btn ghost">Fullscreen</button>
            </div>
            <div class="tv-wrapper" id="tvContainer">
              <div id="tv_embed"></div>
            </div>
          </div>
        </aside>
      </div>
    </main>
  </div>

  <!-- Supabase + TradingView -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const supabaseUrl = 'https://eygjxxdgxzatchqgwvep.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5Z2p4eGRneHphdGNoUWd3dmVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzODUyODIsImV4cCI6MjA3Nzk2MTI4Mn0.USOvTWBQ_kW-ty5XkTehYmPJKXeD2_hGGGM40G55tqg';
    const { createClient } = Supabase;
    const supabase = createClient(supabaseUrl, supabaseKey);
    window.supabase = supabase;

    let currentUser = null;
    let currentMentor = null;
    let activeRoom = 'general';

    // Auth check + redirect if not mentor
    async function init() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session) return location.href = 'login.html';
      currentUser = session.user;

      const { data: profile } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
      if (!profile || profile.role !== 'mentor') return location.href = 'login.html';

      currentMentor = profile;
      fillMentorUI();
      loadClients();
      loadUploads();
      loadTradingView();
      setupRealtime();
    }

    function fillMentorUI() {
      document.getElementById('mentorName').textContent = currentMentor.username || currentMentor.email.split('@')[0];
      document.getElementById('mentorEmail').textContent = currentMentor.email;
      document.getElementById('topName').textContent = currentMentor.username || 'Mentor';
      document.getElementById('topEmail').textContent = currentMentor.email;
      document.getElementById('avatarInitials').textContent = (currentMentor.username || 'M').slice(0,2).toUpperCase();
      document.getElementById('profileUsername').value = currentMentor.username || '';
      document.getElementById('profileEmail').value = currentMentor.email;
      if (currentMentor.avatar_url) document.getElementById('profilePreview').src = currentMentor.avatar_url;
    }

    // Tab switching
    document.querySelectorAll('.nav button, #mainTabs .tab').forEach(el => {
      el.addEventListener('click', () => {
        const target = el.dataset.tab || el.dataset.show;
        if (!target) return;

        document.querySelectorAll('.nav button, #mainTabs .tab').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        const content = document.getElementById(target.replace('Tab','') + (target.includes('Tab') ? '' : 'Tab'));
        if (content) content.style.display = 'block';
      });
    });

    // Logout
    document.getElementById('btnLogout').onclick = async () => {
      await supabase.auth.signOut();
      location.href = 'login.html';
    };

    // Profile save + photo upload
    document.getElementById('photoUpload').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const { data, error } = await supabase.storage.from('avatars').upload(`mentor-${currentUser.id}`, file, { upsert: true });
      if (!error) {
        const { data: { publicUrl } } = supabase.storage.from('avatars').getPublicUrl(`mentor-${currentUser.id}`);
        document.getElementById('profilePreview').src = publicUrl + '?' + Date.now();
        await supabase.from('profiles').update({ avatar_url: publicUrl }).eq('id', currentUser.id);
      }
    };

    document.getElementById('profileForm').onsubmit = async (e) => {
      e.preventDefault();
      const username = document.getElementById('profileUsername').value.trim();
      const email = document.getElementById('profileEmail').value.trim();
      const password = document.getElementById('profilePassword').value;

      const updates = { username, email };
      await supabase.from('profiles').update(updates).eq('id', currentUser.id);
      if (password) await supabase.auth.updateUser({ password });

      document.getElementById('profileMsg').textContent = 'Saved successfully';
      fillMentorUI();
    };

    // Chat system
    async function loadClients() {
      const { data } = await supabase.from('profiles').select('id,username').eq('role', 'client');
      const list = document.getElementById('conversationList');
      list.innerHTML = '<div class="conversation active" data-room="general">General Room</div>';
      data?.forEach(c => {
        const div = document.createElement('div');
        div.className = 'conversation';
        div.dataset.room = `dm_${c.id}`;
        div.textContent = c.username || c.id.slice(0,8);
        div.onclick = () => selectRoom(`dm_${c.id}`, c.username || 'Client');
        list.appendChild(div);
      });
    }

    function selectRoom(room, title = 'Chat') {
      activeRoom = room;
      document.getElementById('chatTitle').textContent = title;
      document.querySelectorAll('.conversation').forEach(c => c.classList.toggle('active', c.dataset.room === room));
      loadMessages();
    }

    async function loadMessages() {
      const { data } = await supabase.from('messages').select('*').eq('room', activeRoom).order('created_at', { ascending: true });
      const win = document.getElementById('chatWindow');
      win.innerHTML = '';
      data?.forEach(m => appendMessage(m));
    }

    function appendMessage(m) {
      const div = document.createElement('div');
      div.className = `msg ${m.sender_id === currentUser.id ? 'sent' : 'recv'}`;
      div.innerHTML = `<div>${escapeHtml(m.message)}</div><small>${new Date(m.created_at).toLocaleTimeString()}</small>`;
      document.getElementById('chatWindow').appendChild(div);
      div.scrollIntoView();
    }

    document.getElementById('sendForm').onsubmit = async (e) => {
      e.preventDefault();
      const input = document.getElementById('messageInput');
      const msg = input.value.trim();
      if (!msg) return;
      await supabase.from('messages').insert({ room: activeRoom, sender_id: currentUser.id, message: msg });
      input.value = '';
    };

    function setupRealtime() {
      supabase.channel('messages').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
        if (payload.new.room === activeRoom) appendMessage(payload.new);
      }).subscribe();
    }

    // Uploads
    document.getElementById('uploadForm').onsubmit = async (e) => {
      e.preventDefault();
      const title = document.getElementById('uploadTitle').value.trim();
      const url = document.getElementById('uploadFile').value.trim();
      if (!title || !url) return;
      await supabase.from('uploads').insert({ mentor_id: currentUser.id, title, url });
      document.getElementById('uploadMsg').textContent = 'Uploaded!';
      loadUploads();
    };

    async function loadUploads() {
      const { data } = await supabase.from('uploads').select('*').eq('mentor_id', currentUser.id).order('created_at', { ascending: false }).limit(10);
      const list = document.getElementById('uploadsList');
      list.innerHTML = data?.map(u => `<li><a href="${u.url}" target="_blank" style="color:var(--gold-dark);font-weight:700">${u.title}</a></li>`).join('') || '<li>No uploads yet</li>';
    }

    // TradingView
    function loadTradingView() {
      new TradingView.widget({
        container_id: "tv_embed",
        width: "100%", height: 400,
        symbol: "BINANCE:BTCUSDT", interval: "60", timezone: "Etc/UTC",
        theme: "light", style: "1", locale: "en",
        toolbar_bg: "#f9f6f2", enable_publishing: false
      });
    }

    document.getElementById('btnFullScreenTV').onclick = () => {
      document.getElementById('tvContainer').requestFullscreen();
    };

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Start
    init();
  </script>
</body>
</html>
