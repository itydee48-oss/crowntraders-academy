<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crown Trade — Admin Login</title>
  <style>
    body{background:#F9F6F2;font-family:sans-serif;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;color:#2e2e2e;}
    .box{background:white;padding:60px 50px;border-radius:20px;box-shadow:0 30px 80px rgba(0,0,0,0.1);text-align:center;width:420px;}
    h1{font-size:2.8rem;color:#C8A97E;margin-bottom:10px;font-family:serif;}
    .admin-badge{background:#EF4444;color:white;padding:4px 12px;border-radius:20px;font-size:0.8rem;margin-bottom:20px;display:inline-block;}
    input{width:100%;padding:18px;margin:15px 0;border-radius:14px;border:1px solid #ddd;font-size:1.1rem;}
    button{background:#EF4444;color:white;border:none;padding:18px;border-radius:14px;font-weight:bold;font-size:1.2rem;cursor:pointer;width:100%;}
    .msg{margin-top:20px;font-weight:600;}
    .warning{background:#FEF3CD;border:1px solid #F59E0B;color:#92400E;padding:15px;border-radius:10px;margin:20px 0;}
  </style>
</head>
<body>
<div class="box">
  <h1>Crown Trade</h1>
  <div class="admin-badge">ADMIN ACCESS</div>
  
  <!-- Show error if coming from expired link -->
  <div id="errorMessage" class="warning" style="display:none;">
    <strong>Link Expired:</strong> Your magic link has expired. Please request a new one.
  </div>
  
  <p>Enter admin email for magic link authentication</p>
  <input type="email" id="email" placeholder="admin@crowntrade.com" required>
  <button onclick="sendAdminMagicLink()">Send Admin Magic Link</button>
  <div id="msg" class="msg"></div>
  <div style="margin-top:20px;font-size:0.9rem;color:#666;">
    <a href="login.html" style="color:#C8A97E;">← Back to User Login</a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = 'https://lskjshbcniilzlyxecww.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxza2pzaGJjbmlpbHpseXhlY3d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MzcwMjksImV4cCI6MjA3OTIxMzAyOX0.PxvhBTZ2Bv4hnwxTrFA0E_zucNxMYrVwDSuRGniDBnc';

const { createClient } = supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

// Check for expired link error on page load
document.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.hash.substring(1));
  const error = urlParams.get('error');
  
  if (error === 'otp_expired') {
    document.getElementById('errorMessage').style.display = 'block';
    // Clear the URL
    window.history.replaceState({}, document.title, window.location.pathname);
  }
});

async function sendAdminMagicLink() {
  const email = document.getElementById('email').value.trim();
  const msg = document.getElementById('msg');
  
  if (!email) {
    msg.textContent = 'Please enter admin email address';
    msg.style.color = 'red';
    return;
  }

  msg.textContent = 'Sending admin magic link...';
  msg.style.color = '#2e2e2e';

  try {
    const { error } = await supabaseClient.auth.signInWithOtp({
      email,
      options: { 
        emailRedirectTo: window.location.origin + '/admin-dashboard.html',
        shouldCreateUser: false // Important: Don't create new users for admin login
      }
    });

    if (error) {
      msg.style.color = 'red';
      msg.textContent = 'Error: ' + error.message;
    } else {
      msg.style.color = 'green';
      msg.textContent = 'Admin magic link sent! Check your email immediately. Links expire quickly.';
    }
  } catch (error) {
    msg.style.color = 'red';
    msg.textContent = 'Failed to send magic link. Please try again.';
  }
}

// Check if user is already logged in and is admin
supabaseClient.auth.getSession().then(async ({ data: { session } }) => {
  if (session) {
    const { data: adminProfile } = await supabaseClient
      .from('admin_profiles')
      .select('id')
      .eq('id', session.user.id)
      .single();
    
    if (adminProfile) {
      window.location.href = 'admin-dashboard.html';
    }
  }
});

// Auto-redirect admin users
supabaseClient.auth.onAuthStateChange(async (event, session) => {
  if (event === 'SIGNED_IN' && session) {
    const { data: adminProfile } = await supabaseClient
      .from('admin_profiles')
      .select('id')
      .eq('id', session.user.id)
      .single();
    
    if (adminProfile) {
      window.location.href = 'admin-dashboard.html';
    } else {
      await supabaseClient.auth.signOut();
      document.getElementById('msg').style.color = 'red';
      document.getElementById('msg').textContent = 'Access denied. Admin access only.';
    }
  }
});

// Enter key support
document.getElementById('email').addEventListener('keypress', function(e) {
  if (e.key === 'Enter') {
    sendAdminMagicLink();
  }
});
</script>
</body>
</html>
